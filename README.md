# 家用网络智能墨水屏万年历

## 产品介绍

家用网络智能墨水屏万年历是一款集传统万年历功能与现代智能科技于一体的家居电子产品。它采用低功耗墨水屏显示，结合WiFi联网功能，实现了天气预报、温度湿度监测、远程推送留言、股票曲线显示等多种智能功能，并支持插件扩展。

### 新增功能

- **双模式远程通讯**：支持IPv6直接访问和设备定时拉取两种方式，确保设备在各种网络环境下都能正常接收消息
- **图片显示支持**：支持推送图片作为留言，以及解析插件中的图片元素
- **多设备管理**：WebServer支持设备自动识别和绑定，实现免注册的多设备管理

## 代码兼容性和原理

### 代码兼容性设计

1. **模块化设计**：采用模块化架构，各功能模块之间低耦合，便于扩展和维护
2. **硬件抽象层**：通过`config.h`和硬件型号枚举，实现了对多种ESP32系列芯片的兼容支持
3. **跨平台编译**：支持PlatformIO和Arduino IDE两种编译环境，便于不同用户使用
4. **动态配置**：通过配置文件实现功能开关和参数调整，无需修改代码即可适配不同硬件和需求
5. **插件机制**：支持动态加载和运行插件，便于功能扩展
6. **自动硬件检测**：支持自动检测传感器类型，无需手动配置即可适配不同传感器
7. **错误容错机制**：各模块添加了异常处理和错误恢复机制，确保单个部件故障不会导致整个系统崩溃
8. **电源管理优化**：实现了智能电源管理，根据设备状态自动调整功耗，延长电池寿命

### 代码优化和容错性

#### 系统强壮性设计

1. **分层异常处理**：采用分层异常处理机制，从模块级别到系统级别都有完善的异常捕获和处理
2. **安全模式保障**：系统初始化失败时自动进入安全模式，保留基本功能，确保可以进行刷机或更新
3. **看门狗机制**：内置软件看门狗，防止系统进入死循环
4. **内存管理优化**：严格的内存分配和释放管理，减少内存泄漏风险
5. **固件更新容错**：固件更新过程中支持断点续传和验证，防止更新失败导致设备变砖

#### 容错性设计

1. **传感器容错**：支持传感器自动检测和故障屏蔽，当某个传感器故障时自动切换到其他可用传感器或使用模拟数据
2. **显示驱动容错**：显示驱动异常时自动重置，确保显示功能不会完全失效
3. **网络连接容错**：WiFi连接失败时自动重试，重试次数有限制，避免无限重试浪费电量
4. **模块隔离机制**：各功能模块之间通过抽象接口通信，单个模块故障不会影响其他模块运行
5. **数据有效性验证**：所有传感器数据和网络数据都经过有效性验证，防止无效数据导致系统崩溃

#### 扩展性设计

1. **硬件抽象接口**：定义了统一的硬件抽象接口（如`IDisplayDriver`、`ISensorDriver`），便于添加新硬件支持
2. **驱动工厂模式**：采用工厂模式创建硬件驱动，新增硬件只需要实现抽象接口并注册到工厂即可
3. **插件扩展机制**：支持URL插件、XML/JSON/JS插件，便于快速扩展功能
4. **模块化架构**：清晰的模块划分，便于新功能模块的添加和集成
5. **配置驱动设计**：通过配置文件驱动功能，无需修改代码即可启用或禁用功能

#### 易读性设计

1. **统一命名规范**：采用清晰的命名规范，变量、函数和类名具有描述性
2. **详细注释**：关键代码和复杂逻辑都有详细的注释说明
3. **模块化结构**：代码结构清晰，模块职责明确
4. **设计模式应用**：合理应用设计模式，提高代码的可理解性和可维护性
5. **文档化设计**：代码结构和模块关系都有文档说明，便于新开发者快速上手

### 核心工作原理

1. **双模式远程通讯原理**
   - **IPv6直接通讯**：当设备检测到具有公网IPv6地址时，自动启动内置Web服务器，允许外部设备直接通过IPv6地址访问设备API，推送消息
   - **设备定时拉取**：设备定期向云端WebServer发送请求，检查是否有新消息，确保在IPv4网络或无公网IPv6环境下也能正常接收消息
   - **自动切换机制**：设备根据网络环境自动选择最优通讯方式，无需人工干预

2. **图片显示原理**
   - **图片解码**：支持JPG、PNG等常见图片格式的解码和显示
   - **内存优化**：采用分块解码和显示策略，优化内存使用，适配ESP32系列芯片的内存限制
   - **缓存机制**：实现图片缓存，减少重复下载和解析，提高显示效率

3. **WebServer架构**
   - **RESTful API设计**：采用标准RESTful API设计，支持设备注册、消息推送、状态查询等功能
   - **PHP实现**：使用PHP语言开发，兼容大多数虚拟主机环境，便于用户自行部署
   - **设备识别机制**：通过设备MAC地址和硬件型号自动识别和绑定设备，实现免注册的多设备管理

4. **墨水屏显示优化**
   - **局部刷新**：根据内容类型实现智能局部刷新，降低功耗，延长屏幕寿命
   - **灰度处理**：针对墨水屏特性优化图片显示，提高图片清晰度和对比度
   - **自适应布局**：根据不同尺寸的墨水屏自动调整布局，适配多种硬件型号

## 功能特性

### 核心功能

- 时钟显示（数字/模拟表盘）
- 万年历功能（农历、节气、节日）
- 温度湿度监测
- 天气预报（未来3-7天）
- WiFi联网
- 蓝牙配置
- 低功耗模式
- 硬件自动检测和适配

### 智能功能

- 远程推送文字留言
- 远程推送音频留言
- 远程推送图片留言
- 本地语音留言
- 视频留言录制和播放（仅支持ESP32-S3系列）
- 指定股票曲线显示
- 插件扩展支持
- 插件图片解析和显示

### 交互功能

- 按键操作支持
- 触屏操作优化（仅支持ESP32-S3系列）
- 人体感应自动唤醒

### 显示功能

- 多种主题切换
- 局部刷新优化
- 自动亮度调整
- 多种字体大小选择
- 图片消息显示
- 网页插件图片解析
- **智能屏幕适配**
  - 根据屏幕尺寸自动调整布局比例
  - 小屏幕优化：紧凑布局，优先显示核心内容
  - 大屏幕优化：宽松布局，展示更多信息
  - 自适应字体大小和元素间距
  - 动态分屏比例（小屏1:1，大屏1:2）

### 网络功能

- **双模式远程通讯**
  - IPv6直接访问（支持手机直接访问设备IPv6地址推送消息）
  - 设备定时拉取（设备定期请求WebServer获取更新）
- **WebServer支持**
  - 设备自动注册和绑定
  - 消息推送和管理
  - 多设备支持
  - 兼容大多数虚拟主机环境

## 屏幕布局适配说明

### 自适应布局设计

系统采用智能自适应布局设计，根据不同屏幕尺寸自动调整显示内容和布局参数，确保在各种墨水屏设备上都能获得最佳显示效果。

### 布局适配策略

| 屏幕类型 | 尺寸范围 | 布局特点 | 分屏比例 | 字体大小 |
|---------|---------|---------|---------|---------|
| 小屏幕 | < 400px 高度 | 紧凑布局，优先显示核心内容 | 1:1（左右各占一半） | 较小字体，节省空间 |
| 大屏幕 | ≥ 400px 高度 | 宽松布局，展示更多信息 | 1:2（左侧1/3，右侧2/3） | 较大字体，提高可读性 |

## 兼容性特点

- **广泛的硬件支持**：兼容多种ESP32系列开发板、墨水屏、传感器和音频模块
- **灵活的配置选项**：通过`config.h`文件可轻松配置硬件型号和功能参数
- **跨平台编译**：支持PlatformIO和Arduino IDE两种编译环境
- **WebServer兼容性**：PHP开发，兼容大多数虚拟主机环境
- **网络兼容性**：支持IPv4和IPv6网络环境，自动切换最优通讯方式

## 支持的硬件列表

### 开发板型号

| 芯片类型 | 推荐型号 | 主要特点 | 价格范围（元） |
|---------|---------|---------|-------------|
| ESP32-C3 | ESP32-C3-DevKitC-02 | 低成本，内置WiFi/BLE，适合入门 | 15-25 |
| ESP32-S3 | ESP32-S3-DevKitC-1 | 高性能，大内存，支持触摸和摄像头 | 35-50 |
| ESP32-C6 | ESP32-C6-N4 | 支持WiFi6，低功耗，高性能 | 25-35 |
| ESP32-C3 | ESP32-C3-Supermini | 超小尺寸，低成本，适合紧凑设计 | 10-20 |
| ESP32-S2 | ESP32-S2-DevKitC-1 | 低功耗，适合电池供电设备 | 20-30 |
| ESP32-S3 | ESP32-Pro-S3 | 专业版，更多GPIO，适合复杂应用 | 40-60 |
| ESP32 | ESP32-WROOM-32E | 经典型号，稳定可靠，成本适中 | 20-35 |
| ESP32 | ESP32-DevKitC-32E | 经典开发板，适合学习和原型开发 | 18-30 |
| ESP32-C3 | ESP32-C3-DevKitM-1 | 小型开发板，适合空间受限应用 | 12-22 |
| ESP32-S3 | ESP32-S3-WROOM-1 | 支持触摸和摄像头，适合多媒体应用 | 30-45 |
| ESP32-C6 | ESP32-C6-DevKitM-1 | 小型WiFi6开发板，低功耗设计 | 20-30 |
| ESP32 | ESP32-Pro | 专业版开发板，更多GPIO和存储空间 | 35-50 |

### 墨水屏型号

| 品牌 | 型号 | 尺寸 | 颜色 | 新品价格范围（元） | 二手/拆机价格范围（元） |
|-----|-----|-----|-----|----------------|-------------------|
| Good Display | GDEW042Z15 | 4.2寸 | 三色 | 45-65 | 15-30 |
| Good Display | GDEW075Z09 | 7.5寸 | 三色 | 80-120 | 30-60 |
| Good Display | GDEW0583T7 | 5.83寸 | 三色 | 60-90 | 25-45 |
| Waveshare | 2.13inch e-Paper HAT | 2.13寸 | 双色 | 30-45 | 10-20 |
| Waveshare | 4.2inch e-Paper HAT | 4.2寸 | 单色 | 40-60 | 15-30 |
| Waveshare | 7.5inch e-Paper HAT | 7.5寸 | 双色 | 70-100 | 25-50 |
| Boardsource | 3.7inch e-Paper Display | 3.7寸 | 单色 | 50-70 | 20-35 |
| Good Display | GDEW027W3 | 2.7寸 | 单色 | 25-35 | 8-15 |
| Good Display | GDEW0154M09 | 1.54寸 | 单色 | 15-25 | 5-12 |
| Waveshare | 5.65inch e-Paper Module | 5.65寸 | 三色 | 65-95 | 25-45 |
| Waveshare | 2.9inch e-Paper HAT | 2.9寸 | 双色 | 35-50 | 12-25 |
| Good Display | GDEW0437Z90 | 4.37寸 | 三色 | 50-75 | 20-40 |
| Good Display | GDEW054Z01 | 5.4寸 | 双色 | 55-80 | 20-40 |
| Good Display | GDEW060Z10 | 6.0寸 | 双色 | 75-110 | 30-55 |
| 盒马鲜生 | 盒马三色电子标签 | 4.2寸 | 三色 | - | 5-15 |
| 京东到家 | 京东到家电子价签 | 2.9寸 | 双色 | - | 3-10 |
| 大润发 | 大润发电子价签 | 4.2寸 | 单色 | - | 2-8 |
| 永辉超市 | 永辉超市电子价签 | 5.83寸 | 三色 | - | 8-25 |
| 小米 | 小米智能电子标签 | 2.13寸 | 双色 | - | 5-15 |
| 超市通用 | 通用电子价签 | 1.54寸 | 双色 | - | 2-5 |
| 超市通用 | 通用电子价签 | 2.66寸 | 双色 | - | 3-8 |
| 超市通用 | 通用电子价签 | 3.12寸 | 双色 | - | 4-10 |
| 二手阅读器 | Kindle拆解屏 | 6寸 | 单色 | - | 20-50 |
| 二手阅读器 | 文石/掌阅拆解屏 | 7.8寸 | 单色 | - | 50-100 |
| 二手阅读器 | 彩色墨水屏 | 6-10寸 | 三色/四色 | - | 100-300 |

### 温湿度传感器

| 品牌 | 型号 | 接口 | 精度 | 价格范围（元） |
|-----|-----|-----|-----|-------------|
| Aosong | DHT22 | 单总线 | ±0.5℃/±2%RH | 15-25 |
| Sensirion | SHT30 | I2C | ±0.3℃/±2%RH | 20-35 |
| Aosong | DHT11 | 单总线 | ±2℃/±5%RH | 5-10 |
| Bosch | BME280 | I2C/SPI | ±0.5℃/±3%RH | 15-28 |
| Texas Instruments | HDC1080 | I2C | ±0.2℃/±2%RH | 15-25 |
| Aosong | AM2302 | 单总线 | ±0.5℃/±2%RH | 12-20 |
| Sensirion | SHT21 | I2C | ±0.3℃/±2%RH | 18-30 |
| Sensirion | SHT40 | I2C | ±0.2℃/±1.5%RH | 25-40 |
| Measurement Specialties | HTU21D | I2C | ±0.3℃/±2%RH | 18-30 |
| Silicon Labs | SI7021 | I2C | ±0.4℃/±3%RH | 15-25 |
| Bosch | BME680 | I2C/SPI | ±0.5℃/±3%RH | 35-55 |
| Aosong | DHT12 | I2C | ±0.5℃/±4%RH | 8-15 |

### 人体感应传感器

| 品牌 | 型号 | 类型 | 感应距离 | 价格范围（元） |
|-----|-----|-----|---------|-------------|
| 多种品牌 | HC-SR501 | 红外 | 3-7米 | 8-15 |
| Hi-Link | LD2410 | 毫米波雷达 | 0.3-4米 | 35-55 |
| Hi-Link | LD2410C | 毫米波雷达 | 0.5-8米 | 45-70 |
| 多种品牌 | RCWL-0516 | 雷达 | 5-7米 | 12-20 |
| 多种品牌 | SR505 | 红外 | 2-6米 | 5-12 |
| 多种品牌 | AM312 | 红外 | 3-5米 | 6-12 |
| 多种品牌 | HC-SR505 | 红外 | 1-5米 | 7-15 |
| 多种品牌 | RCWL-0801 | 雷达 | 3-8米 | 15-25 |
| 多种品牌 | AM612 | 红外 | 3-6米 | 8-15 |
| 多种品牌 | PIR-501B | 红外 | 2-7米 | 6-12 |
| 多种品牌 | HC-SR503 | 红外 | 3-7米 | 8-15 |
| 多种品牌 | RCWL-1205 | 雷达 | 4-7米 | 15-25 |
| 多种品牌 | SR602 | 红外 | 3-7米 | 8-15 |

### 音频模块

| 品牌 | 型号 | 功能 | 价格范围（元） |
|-----|-----|-----|-------------|
| VLSI Solutions | VS1053B | MP3解码，录音 | 35-55 |
| Texas Instruments | UDA1334A | 高保真音频编解码 | 25-40 |
| Maxim Integrated | MAX98357A | 单声道音频放大器 | 10-18 |
| Texas Instruments | PCM5102A | 立体声音频解码器 | 15-25 |
| Everest Semiconductor | ES8388 | 高清音频编解码器 | 45-70 |
| Diodes Incorporated | PAM8403 | 双声道音频放大器 | 8-15 |
| Cirrus Logic | WM8978 | 音频编解码器 | 30-45 |
| Texas Instruments | TPA3116D2 | 数字音频放大器 | 20-35 |
| Princeton Technology | PT2314 | 音频处理器 | 12-20 |
| Everest Semiconductor | ES7243E | 音频ADC | 25-40 |
| Actions Semiconductor | AC101 | 音频编解码器 | 20-35 |
| Cirrus Logic | CS4344 | 立体声数模转换器 | 30-50 |
| NXP Semiconductors | TFA9879 | 音频放大器 | 15-25 |
| CMedia | CM108 | USB音频芯片 | 20-35 |

## 易用性说明

- **免注册多设备支持**：设备自动识别和绑定，无需手动注册
- **蓝牙快速配置**：支持通过蓝牙快速配置WiFi信息
- **智能更新机制**：根据内容类型自动调整刷新频率，延长设备寿命
- **插件扩展**：支持动态加载插件，轻松扩展功能
- **详细的DIY文档**：提供完整的硬件选购、组装和软件配置指南

## 快速开始

### 硬件准备

请参考[硬件物料选型文档](hardware/硬件物料选型.md)选择适合的硬件组合。

### 软件配置

1. 克隆代码仓库
2. 配置`code/src/config.h`文件，选择适合的硬件型号和配置
3. 使用PlatformIO或Arduino IDE编译并上传代码
4. 设备首次启动后，通过蓝牙配置WiFi信息
5. 设备联网后自动注册到WebServer

### WebServer部署

1. 将`webserver`目录下的所有文件上传到虚拟主机
2. 配置`config.php`中的数据库连接信息
3. 导入`init_db.sql`创建数据库表
4. 确保虚拟主机支持PHP和MySQL

## 开发文档

- [产品需求文档](doc/产品需求文档.md)
- [硬件物料选型](hardware/硬件物料选型.md)
- [开发硬件说明](dev/开发硬件说明.md)
- [电路设计](elec/电路设计.md)
- [DIY指南](diy_readme.md)

## 版本历史

- v1.0 - 初始版本
- v1.1 - 增加低功耗模式
- v1.2 - 增加多种主题支持
- v1.3 - 扩展硬件兼容性
- v1.4 - 增加双模式远程通讯和图片显示功能

## 许可证

MIT License
