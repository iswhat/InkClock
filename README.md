# 家用网络智能墨水屏万年历

## 项目简介

家用网络智能墨水屏万年历是一款支持多种低功耗WiFi+蓝牙双模微控制器的智能设备，采用墨水屏显示，具有低功耗、高清晰度、可远程配置等特点。设备采用三层架构设计，能够自动获取时间、天气、农历、节假日等信息，并支持模块化扩展和二次开发。

## 三层架构设计

### 1. 底层操作系统（CoreSystem）

底层操作系统是系统的核心，负责管理系统资源、提供基础服务，与硬件直接交互。

#### 核心功能
- **电源管理**：低功耗模式控制、电池电量监测、充电状态管理
- **配置管理**：统一的配置存储和访问API
- **定时器管理**：支持周期性和一次性定时器
- **事件总线**：模块间通信的核心，支持85+事件类型
- **系统安全**：错误处理、安全模式保障

#### 设计特点
- 最小核心运行，最大稳定性
- 与应用层完全解耦
- 支持多种硬件平台
- 低功耗设计，续航时间长

### 2. 驱动程序层

驱动程序层提供统一的设备抽象接口，支持动态注册和管理传感器、显示设备等硬件。

#### 核心功能
- **传感器驱动**：支持多种温湿度、人体感应、光照、气体、火焰等传感器
- **显示驱动**：支持多种尺寸和类型的墨水屏
- **驱动注册中心**：动态管理驱动，支持自动检测和设备发现

#### 设计特点
- 统一的驱动接口，易于扩展
- 支持热插拔和动态加载
- 自动检测和设备发现
- 支持多种硬件平台

### 3. 应用层

应用层包含各种功能模块，通过事件总线与底层通信，实现具体的业务逻辑。

#### 核心功能
- **时间管理**：NTP时间同步、时间显示
- **天气管理**：天气数据获取和显示
- **农历管理**：农历日期、节气、节假日显示
- **传感器数据管理**：传感器数据采集和显示
- **显示管理**：页面渲染和显示刷新
- **插件管理**：动态加载和卸载插件

#### 设计特点
- 事件驱动编程，模块间低耦合
- 支持动态插件扩展
- 易于开发和维护
- 支持多种应用场景

## 主要功能

1. **实时时间显示**：支持NTP时间同步，自动处理时区和夏令时
2. **天气信息展示**：显示当前天气、温度、湿度、风力等信息，支持5天天气预报
3. **农历与节假日**：显示农历日期、节气、节假日信息
4. **地理位置自动识别**：通过网络IP自动检测地理位置，也可手动配置
5. **传感器数据监测**：支持温湿度、人体感应、光照、气体、火焰等传感器数据采集和显示
6. **模块化设计**：支持插件扩展，可方便添加新功能
7. **远程配置**：通过Web页面进行设备配置和管理
8. **低功耗设计**：采用墨水屏和智能电源管理，续航时间长
9. **多种网络支持**：支持WiFi连接，支持IPv6
10. **蓝牙配置**：支持首次WiFi配置
11. **远程留言推送**：支持文字、图片、音频（需TF卡）、视频（需TF卡）等留言推送
12. **股票数据展示**：显示关注股票的实时行情和大盘曲线
13. **插件功能扩展**：支持古诗、英语单词等插件，可根据需要扩展更多功能
14. **字体管理功能**：支持自定义字体上传和选择
15. **TF卡功能**：用于存储音频、图片、视频等数据
16. **TF卡管理功能**：用于管理TF卡中的内容
17. **本地视频留言**：支持本地录制视频留言（需摄像头和TF卡）

## 快速开始

### 硬件连接

1. 将墨水屏连接到ESP32开发板
2. 连接传感器（可选）
3. 连接电源

### 软件烧录

1. 安装PlatformIO IDE
2. 克隆项目代码
3. 在PlatformIO中打开项目
4. 选择对应的开发板型号
5. 修改`src/coresystem/config.h`中的基本配置
6. 编译并上传固件

### 首次配置

1. 设备启动后，会创建一个名为"InkClock-XXXX"的WiFi热点
2. 用手机或电脑连接该热点
3. 在浏览器中访问192.168.4.1
4. 配置WiFi信息和基本设置
5. 保存配置后，设备会自动连接到指定的WiFi网络

### 正常使用

设备连接WiFi后，会自动获取时间、天气等信息，并在墨水屏上显示。您可以通过以下方式管理设备：

1. **Web配置页面**：在浏览器中访问设备的IP地址
2. **配置地理位置**：在Web页面中开启自动检测或手动输入地理位置信息
3. **更新频率设置**：调整时间、天气等信息的更新频率
4. **插件管理**：添加、启用、禁用插件

## 二次开发

### 开发环境搭建

1. 安装PlatformIO IDE
2. 克隆项目代码
3. 在PlatformIO中打开项目
4. 安装所需的依赖库

### 固件生成工具

项目提供了一个命令行固件生成工具，用于根据实际需求生成最简固件，支持自定义选择硬件型号和功能模块。

#### 工具功能

- **运行环境检测**：自动检查Python版本和依赖包
- **硬件型号选择**：支持多种墨水屏和传感器型号选择
- **功能模块定制**：可启用或禁用相应功能模块
- **自动配置更新**：自动更新main.cpp中的条件编译宏
- **最简代码生成**：生成适合所选配置的最简代码

#### 工具位置

```
d:\InkClock\tool\generate_firmware.py
```

#### 使用方法

**Windows用户**：
```
cd d:\InkClock\tool
generate_firmware.bat
```

**Linux/Mac用户**：
```
cd /path/to/InkClock/tool
python3 generate_firmware.py
```

## 架构设计文档

### 事件总线

事件总线是系统的核心通信机制，支持85+事件类型，包括：

- **系统事件**：系统启动、错误、电源状态变化等
- **驱动事件**：驱动注册、注销、设备发现等
- **传感器事件**：传感器数据更新、配置变化等
- **显示事件**：显示更新、页面切换等
- **时间事件**：时间更新、日期变化等
- **天气事件**：天气数据更新等
- **农历事件**：农历数据更新等
- **插件事件**：插件加载、卸载、配置变化等

### 驱动注册中心

驱动注册中心管理所有传感器和显示驱动，支持：

- 动态注册和注销驱动
- 自动检测和设备发现
- 驱动状态管理
- 多驱动支持

### 插件系统

插件系统支持动态加载和卸载插件，包括：

- 插件生命周期管理
- 插件配置管理
- 插件事件发布
- 在线插件获取

## 配置说明

主要配置文件为`src/coresystem/config.h`，包含以下主要配置项：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| DISPLAY_TYPE | 显示类型 | EINK_75_INCH |
| DISPLAY_UPDATE_INTERVAL | 显示更新间隔（毫秒） | 60000 |
| AUTO_DETECT_LOCATION | 是否自动检测地理位置 | true |
| NTP_SERVER | NTP服务器 | "ntp.aliyun.com" |
| TIME_ZONE_OFFSET | 时区偏移（小时） | 8 |
| WEATHER_UPDATE_INTERVAL | 天气更新间隔（毫秒） | 3600000 |
| SENSOR_UPDATE_INTERVAL | 传感器更新间隔（毫秒） | 60000 |
| LOW_POWER_MODE_ENABLED | 是否启用低功耗模式 | true |

## 兼容元器件列表

### 主控芯片
- **ESP32系列**：ESP32-S3、ESP32-C3、ESP32-C6、ESP32-S2、ESP32-WROOM-32
- **ESP8266系列**：ESP8266-12F、ESP8266-07、ESP8266-WROOM-02
- **NRF52系列**：NRF52832、NRF52840
- **STM32系列**：STM32L4、STM32G4、STM32F4
- **RP2040系列**：Raspberry Pi Pico W

### 显示屏幕
- 标准墨水屏：1.54/2.13/2.66/2.7/2.9/3.12/4.2/4.37/5.4/5.83/6.0/7.5/7.8/10.3/12.48英寸
- 电子价签：1.54/2.13/2.66/2.9/3.12英寸双色电子价签
- 二手阅读器屏幕：6.0/7.8/10.3英寸单色/彩色阅读器屏幕

### 传感器
- **温湿度传感器**：DHT11、DHT12、DHT22、AM2302、SHT20、SHT21、SHT30、SHT40、HDC1080、HTU21D、SI7021、BME280、BME680
- **人体感应传感器**：PIR（通用）、HC-SR501、HC-SR505、RE200B、LD2410
- **光照传感器**：BH1750、TSL2561、GY30、SI1145
- **气体传感器**：MQ2、MQ5、MQ7、MQ8、MQ135、TGS2600、SGP30
- **火焰传感器**：IR火焰传感器、UV火焰传感器
- **气压传感器**：BMP280、BMP388、LPS25HB

### 电源模块
- **软包聚合物电池（3.7V）**：仅支持软包聚合物电池，保持产品轻薄
- **Type-C充电模块**：USB-Type-C接口，支持10W-20W充电功率，带充电保护
- **TP4056+Type-C充电模块**：性价比高，支持USB-Type-C接口
- **AXP192+Type-C电源管理模块**：功能强大，支持电量监测和充电管理

**注意：本设备仅支持USB-Type-C充电接口，不支持DC直插供电**

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 贡献

欢迎提交Issue和Pull Request，共同完善项目。

## 作者信息

- 开发者：iswhat
- GitHub：https://github.com/iswhat/InkClock

## 版本历史

### v1.3 (2025-12-29)
- 实现三层架构设计：底层操作系统、驱动程序层、应用层
- 完善事件总线，支持85+事件类型
- 实现驱动注册中心，支持动态驱动管理
- 提取底层核心功能，形成独立的"微型操作系统"
- 重构应用层，通过事件总线与底层通信
- 实现插件系统，支持动态加载和卸载插件

### v1.2 (2025-12-29)
- 完善TF卡功能，支持存储音频、视频等数据
- 添加微型麦克风支持，实现本地音频留言功能
- 实现音频录制和播放功能
- 实现照片拍摄功能
- 完善Web界面，添加字体管理和TF卡管理功能
- 优化SPIFFS初始化，确保只初始化一次
- 添加字体文件格式验证
- 优化错误处理和性能

### v1.1 (2025-12-26)
- 新增地理位置自动识别功能
- 优化API管理模块
- 修复部分bug

### v1.0 (2025-12-01)
- 初始版本发布
- 支持基本的时间、天气、农历显示
- 支持Web配置和插件扩展
