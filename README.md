# 家用网络智能墨水屏万年历

## 项目简介

家用网络智能墨水屏万年历是一款基于ESP32的智能设备，采用墨水屏显示，具有低功耗、高清晰度、可远程配置等特点。设备能够自动获取时间、天气、农历、节假日等信息，并支持模块化扩展和二次开发。

## 主要功能

1. **实时时间显示**：支持NTP时间同步，自动处理时区和夏令时
2. **天气信息展示**：显示当前天气、温度、湿度、风力等信息，支持5天天气预报
3. **农历与节假日**：显示农历日期、节气、节假日信息
4. **地理位置自动识别**：通过网络IP自动检测地理位置，也可手动配置
5. **传感器数据监测**：支持温湿度传感器数据采集和显示
6. **模块化设计**：支持插件扩展，可方便添加新功能
7. **远程配置**：通过Web页面进行设备配置和管理
8. **低功耗设计**：采用墨水屏和智能电源管理，续航时间长
9. **多种网络支持**：支持WiFi连接，支持IPv6
10. **蓝牙配置**：支持首次WiFi配置
11. **远程留言推送**：支持文字、图片、音频（需TF卡）、视频（需TF卡）等留言推送
12. **股票数据展示**：显示关注股票的实时行情和大盘曲线
13. **插件功能扩展**：支持古诗、英语单词等插件，可根据需要扩展更多功能
14. **字体管理功能**：支持自定义字体上传和选择
15. **TF卡功能**：用于存储音频、图片、视频等数据
16. **TF卡管理功能**：用于管理TF卡中的内容
17. **本地视频留言**：支持本地录制视频留言（需摄像头和TF卡）

## 软件架构

系统采用模块化设计，主要包含以下模块：

1. **核心模块**：
   - WiFiManager：WiFi连接管理
   - TimeManager：时间同步和管理
   - APIManager：统一API请求管理
   - GeoManager：地理位置管理

2. **功能模块**：
   - WeatherManager：天气数据获取和管理
   - LunarManager：农历和节假日管理
   - SensorManager：传感器数据采集
   - DisplayManager：显示管理

3. **扩展模块**：
   - PluginManager：插件管理
   - WebServerManager：Web服务器
   - MessageManager：消息管理
   - StockManager：股票数据管理

## 快速开始

### 硬件连接

1. 将墨水屏连接到ESP32开发板
2. 连接温湿度传感器（可选）
3. 连接电源

### 软件烧录

1. 安装PlatformIO IDE
2. 克隆项目代码
3. 在PlatformIO中打开项目
4. 选择对应的开发板型号
5. 修改`config.h`中的基本配置
6. 编译并上传固件

### 首次配置

1. 设备启动后，会创建一个名为"InkClock-XXXX"的WiFi热点
2. 用手机或电脑连接该热点
3. 在浏览器中访问192.168.4.1
4. 配置WiFi信息和基本设置
5. 保存配置后，设备会自动连接到指定的WiFi网络

### 正常使用

设备连接WiFi后，会自动获取时间、天气等信息，并在墨水屏上显示。您可以通过以下方式管理设备：

1. **Web配置页面**：在浏览器中访问设备的IP地址
2. **配置地理位置**：在Web页面中开启自动检测或手动输入地理位置信息
3. **更新频率设置**：调整时间、天气等信息的更新频率
4. **插件管理**：添加、启用、禁用插件

## 二次开发

### 开发环境搭建

1. 安装PlatformIO IDE
2. 克隆项目代码
3. 在PlatformIO中打开项目
4. 安装所需的依赖库

### 固件生成工具

项目提供了一个命令行固件生成工具，用于根据实际需求生成最简固件，支持自定义选择硬件型号和功能模块。

#### 工具功能

- **运行环境检测**：自动检查Python版本和依赖包
- **硬件型号选择**：支持多种墨水屏和传感器型号选择
- **功能模块定制**：可启用或禁用相应功能模块
- **自动配置更新**：自动更新main.cpp中的条件编译宏
- **最简代码生成**：生成适合所选配置的最简代码

#### 工具位置

```
d:\InkClock\tool\generate_firmware.py
```

#### 使用方法

**Windows用户**：
```
cd d:\InkClock\tool
generate_firmware.bat
```

**Linux/Mac用户**：
```
cd /path/to/InkClock/tool
python3 generate_firmware.py
```

#### 工具使用流程

1. 运行固件生成工具
2. 按照向导选择墨水屏型号
3. 选择需要的传感器（可多选）
4. 选择需要的功能模块（可多选）
5. 工具自动更新main.cpp中的条件编译宏
6. 工具生成配置文件和最简代码
7. 在`tool/release`目录中查看生成的固件文件

#### 输出结果

- `firmware_info.json`：固件配置信息
- `code/main.cpp`：更新后的最简代码

## Web服务器功能

### 在线插件管理

项目包含一个Web服务器，用于管理在线插件：

- **插件列表页面**：`/plugin/index.php` - 显示推荐插件列表
- **在线插件管理**：`/plugin/manage.php` - 管理在线插件列表
- **插件JSON配置**：`/plugin/plugin.json` - 插件配置文件

### 在线插件功能

- **每日古诗插件**：`/plugin/daily_poem/index.php` - 每天获取一首经典古诗
- **每日英语单词插件**：`/plugin/daily_word/index.php` - 每天学习一个英语单词
- **新闻头条插件**：`/plugin/news_headlines/index.php` - 获取最新新闻头条

### 插件JSON格式

```json
[
  {
    "name": "插件名称",
    "url": "插件URL",
    "description": "插件描述",
    "refresh_interval": "刷新频率",
    "settings_url": "设置接口URL（可选）"
  }
]
```

### 模块扩展

1. **添加新插件**：
   - 在`plugin_manager.h`中定义插件类型
   - 实现插件类，继承自`Plugin`基类
   - 在`plugin_manager.cpp`中注册插件

2. **添加新传感器**：
   - 在`sensor_driver.h`中定义传感器驱动接口
   - 实现传感器驱动类
   - 在`sensor_manager.cpp`中注册传感器

3. **添加新显示驱动**：
   - 在`display_driver.h`中定义显示驱动接口
   - 实现显示驱动类
   - 在`display_manager.cpp`中注册显示驱动

### API调用

系统提供了统一的API管理接口，可用于获取外部数据：

```cpp
// 示例：获取天气数据
String url = "https://api.weather.com/weather";
ApiResponse response = apiManager.get(url, API_TYPE_WEATHER, 3600000);
```

## 配置说明

主要配置文件为`config.h`，包含以下主要配置项：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| AUTO_DETECT_LOCATION | 是否自动检测地理位置 | true |
| GEO_CITY_ID | 默认城市ID | "your_city_id" |
| WEATHER_API_KEY | 天气API密钥 | "your_weather_api_key" |
| WEATHER_UPDATE_INTERVAL | 天气更新间隔（毫秒） | 3600000 |
| DISPLAY_UPDATE_INTERVAL | 显示更新间隔（毫秒） | 300000 |
| TIME_ZONE_OFFSET | 时区偏移（小时） | 8 |

## 常见问题

1. **设备无法连接WiFi**：
   - 检查WiFi密码是否正确
   - 检查WiFi信号强度
   - 尝试重置设备

2. **时间显示不准确**：
   - 检查时区设置是否正确
   - 确保设备能够连接到NTP服务器

3. **天气信息不更新**：
   - 检查天气API密钥是否正确
   - 确保设备能够访问互联网
   - 检查城市ID是否正确

4. **显示异常**：
   - 检查墨水屏连接是否正确
   - 尝试重启设备

## 兼容元器件列表

### 主控芯片
- ESP32-S3
- ESP32-C3
- ESP32-C6
- ESP32-S2
- ESP32-WROOM-32
- ESP32-C3-SUPERMINI
- ESP32-S3-PRO
- ESP32-PRO-S3
- ESP32-S3-WROOM-1

### 显示屏幕
- 标准墨水屏：1.54/2.13/2.66/2.7/2.9/3.12/4.2/4.37/5.4/5.83/6.0/7.5/7.8/10.3/12.48英寸
- 电子价签：1.54/2.13/2.66/2.9/3.12英寸双色电子价签
- 二手阅读器屏幕：6.0/7.8/10.3英寸单色/彩色阅读器屏幕

### 传感器
- **温湿度传感器**：DHT11、DHT22、DHT12、SHT30、SHT21、SHT40、AM2302、HDC1080、BME280、BME680、HTU21D、SI7021
- **人体感应传感器**：HC-SR501、HC-SR505、RE200B、LD2410、BH1750
- **光照传感器**：BH1750、VEML6075、TSL2561、GY30、SI1145
- **气体传感器**：MQ2、MQ5、MQ7、MQ8、MQ135、TGS2600（用于燃气泄露、一氧化碳浓度检测）
- **火焰传感器**：IR火焰传感器、UV火焰传感器、YG1006、MQ2、TGS2600（用于火灾检测）
- **气压传感器**：BMP280、BMP388、LPS25HB
- **土壤湿度传感器**：FC-28、电容式土壤湿度传感器
- **水位传感器**：水位传感器模块、浮球液位开关
- **振动传感器**：SW-420、振动传感器模块
- **声音传感器**：声音传感器模块、MAX9814麦克风
- **加速度传感器**：MPU6050、LSM6DS3
- **距离传感器**：HC-SR04、VL53L0X、TF-Luna
- **心率传感器**：MAX30102、pulseSensor
- **紫外线传感器**：GUVA-S12SD、VEML6075
- **磁场传感器**：HMC5883L、QMC5883L
- **气体流量传感器**：YF-S201、G1/2"气体流量传感器
- **雨滴传感器**：雨滴传感器模块、叶面湿度传感器
- **一氧化碳传感器**：MQ-7、TGS5042
- **甲醛传感器**：MQ-138、ZE08-CH2O
- **氧气传感器**：MQ-131、ME2-O2
- **烟雾传感器**：MQ-2、GP2Y1010AU0F、MQ-135
- **酒精传感器**：MQ-3、MQ-8
- **辐射传感器**：GM Tube Module、AS7341
- **姿态传感器**：MPU9250、BNO055
- **电流传感器**：ACS712-05B、ACS758LCB-050B
- **电压传感器**：电压传感器模块、INA219
- **功率传感器**：INA219、INA3221
- **称重传感器**：HX711+Load Cell、压力传感器
- **触摸传感器**：TTP223、TTP229、CAP1188
- **颜色传感器**：TCS3200、TCS34725、AS7341
- **激光传感器**：激光二极管模块、激光测距模块
- **红外接收器**：TSOP38238、VS1838B
- **红外发射器**：红外发光二极管、红外发射模块
- **摄像头模块**：OV7670、OV2640、GC0308、GC2145
- **麦克风模块**：MAX9814、WM8960、INMP441
- **扬声器模块**：蜂鸣器模块、扬声器模块、MAX98357A
- **LED模块**：LED模块、RGB LED模块、WS2812B
- **继电器模块**：1路继电器模块、2路继电器模块、4路继电器模块
- **电机驱动模块**：L298N、DRV8833、TB6612FNG
- **步进电机驱动模块**：ULN2003、A4988、DRV8825
- **舵机模块**：SG90、MG996R、DS3218
- **编码器模块**：旋转编码器模块、光电编码器

### 存储设备
- MicroSD卡（用于音频、视频存储）
- EEPROM模块
- FRAM模块

### 电源模块
- **软包聚合物电池（3.7V）**：仅支持软包聚合物电池，保持产品轻薄
- **Type-C充电模块**：USB-Type-C接口，支持10W-20W充电功率，带充电保护
- **TP4056+Type-C充电模块**：性价比高，支持USB-Type-C接口
- **AXP192+Type-C电源管理模块**：功能强大，支持电量监测和充电管理

**注意：本设备仅支持USB-Type-C充电接口，不支持DC直插供电**

### 通信模块
- HC-05/HC-06蓝牙模块
- ESP-01S WiFi模块
- NRF24L01无线模块
- LoRa模块
- ZigBee模块
- GPS模块（NEO-6M、NEO-M8N、ATGM336H）
- RFID模块（RC522、MFRC522）
- NFC模块（PN532、RC523）
- 指纹识别模块（AS608、R307、ZFM-20）
- 语音识别模块（LD3320、ASRPro）
- 语音合成模块（SYN6288、XFS5152CE）

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 贡献

欢迎提交Issue和Pull Request，共同完善项目。

## 作者信息

- 开发者：iswhat
- GitHub：https://github.com/iswhat/InkClock

## 版本历史

### v1.1 (2025-12-26)
- 新增地理位置自动识别功能
- 优化API管理模块
- 修复部分bug

### v1.0 (2025-12-01)
- 初始版本发布
- 支持基本的时间、天气、农历显示
- 支持Web配置和插件扩展
