# 家用网络智能墨水屏万年历需求规划

## 1. 产品概述

家用网络智能墨水屏万年历是一款集传统万年历功能与现代智能科技于一体的家居电子产品。它采用低功耗墨水屏显示，结合WiFi联网功能，实现了天气预报、温度湿度监测、远程推送留言、股票曲线显示等多种智能功能，并支持插件扩展，可根据用户需求定制更多功能。产品采用轻薄设计，厚度不超过3cm，使用聚合物软包电池和Type-C充电接口，续航可达50天以上，最高可达150天。

## 2. 功能需求

### 2.1 核心功能

| 功能模块 | 详细描述 |
|---------|---------|
| 时钟显示 | 实时显示时间、日期，支持24/12小时制切换，提供数字和模拟表盘两种显示模式，支持区域刷新 |
| 万年历功能 | 显示农历、节气、节日等信息 |
| 温度湿度监测 | 实时监测室内温度和湿度，显示历史数据趋势 |
| 天气预报 | 显示未来3-7天天气预报，包括温度、天气状况、风力风向等 |
| WiFi联网 | 支持2.4GHz WiFi连接，自动获取网络时间和天气信息 |
| 蓝牙配置 | 首次使用时通过蓝牙连接引导配置WiFi连接 |
| 电量显示 | 显示剩余电量和充电状态 |
| Web管理界面 | 通过浏览器访问设备IP地址的8080端口，进入设备设置界面，支持所有设置操作 |
| 低功耗模式 | 通过HC-SR501人体感应传感器检测无人状态，自动进入低损耗模式：<br>1. 检测逻辑：连续5分钟未检测到人体活动，自动进入低功耗模式<br>2. 刷新策略：进入低功耗模式后，屏幕刷新间隔从1分钟延长至1小时，仅显示核心时间日期信息<br>3. 省电逻辑：关闭非必要功能模块，降低CPU运行频率，减少WiFi连接次数<br>4. 唤醒机制：人体感应传感器检测到活动后，5秒内自动唤醒，恢复正常刷新频率 |

### 2.2 智能功能

| 功能模块 | 详细描述 |
|---------|---------|
| 远程推送文字留言 | 支持手机APP或Web端远程推送文字留言到设备 |
| 远程推送音频留言 | 支持手机APP或Web端远程推送音频留言，设备可播放 |
| 本地语音留言 | 支持本地录音留言功能 |
| 指定股票曲线 | 支持添加指定股票代码，显示股票价格和K线图 |
| 插件支持 | 通过加载Web页面显示插件内容，WiFi连接后在手机端管理；支持填写功能页面URL并设置刷新时间（单位为秒、分、时、天）；通过URL获取页面的代码解析：显示内容、基础布局和名称，不支持解析任何复杂格式或者效果 |

### 2.3 显示功能

| 功能模块 | 详细描述 |
|---------|---------|
| 墨水屏显示 | 采用4.2寸-7.5寸三色墨水屏，低功耗、高对比度，支持区域刷新 |
| 左右分屏布局 | 左侧固定显示：时间、网络来源天气、室温监测、电量、消息通知；右侧可切换显示：万年历（带黄历）、留言板、股票、插件功能（轮换）、插件管理、设置等 |
| 多页面切换 | 支持右侧区域功能切换，可通过按键或远程控制切换 |
| 区域刷新 | 时钟区域支持独立刷新，减少全屏刷新次数，降低功耗 |
| 自定义布局 | 支持用户自定义页面布局，调整各功能模块位置和大小 |
| 定时刷新 | 支持定时刷新屏幕，可设置刷新频率 |
| 时钟显示模式 | 支持数字和模拟表盘两种显示模式，可切换 |
| 设置界面 | 设备端设置界面仅显示设置信息和访问设置的二维码，扫码直接访问 http://ip:8080 |
| 智能屏幕适配 | 根据屏幕尺寸自动调整布局比例：<br>1. 小屏幕（< 400px高度）：紧凑布局，优先显示核心内容，分屏比例1:1（左右各占一半），较小字体节省空间<br>2. 大屏幕（≥ 400px高度）：宽松布局，展示更多信息，分屏比例1:2（左侧1/3，右侧2/3），较大字体提高可读性<br>3. 自适应字体大小和元素间距<br>4. 动态分屏比例（小屏1:1，大屏1:2）<br>5. 所有页面都实现智能适配，包括主页面、消息页面、日历页面、股票页面、插件页面和设置页面 |

### 2.4 交互功能

| 功能模块 | 详细描述 |
|---------|---------|
| 物理按键 | 提供少量物理按键，用于页面切换、音量调节等基本操作 |
| 远程控制 | 支持手机APP或Web端远程控制设备 |
| 语音控制 | 可选支持语音唤醒和控制功能 |

### 2.5 电源管理

| 功能模块 | 详细描述 |
|---------|---------|
| 低功耗设计 | 采用低功耗处理器和墨水屏，支持电池供电，续航可达50天以上，最高可达150天 |
| 电源管理 | 支持自动休眠和唤醒功能，延长电池寿命 |
| 充电功能 | 支持Type-C充电，提供充电指示和电量显示 |
| 电池类型 | 使用聚合物软包电池，轻薄设计，厚度不超过3cm |

## 3. 硬件需求

### 3.1 核心硬件

| 硬件模块 | 需求描述 |
|---------|---------|
| 处理器 | 支持WiFi和蓝牙连接，性能足够运行实时操作系统和各种功能模块 |
| 内存 | 足够存储操作系统、应用程序和数据 |
| 存储 | 支持外部存储扩展，用于存储音频留言、插件等 |
| 墨水屏 | 4.2寸-7.5寸三色墨水屏，支持区域刷新，分辨率不低于800×480 |
| 网络模块 | 2.4GHz WiFi模块，支持802.11b/g/n协议 |
| 蓝牙模块 | 支持蓝牙4.2或以上版本，用于首次WiFi配置 |
| 传感器 | 温湿度传感器，精度不低于±0.5℃/±3%RH |

### 3.2 扩展硬件

| 硬件模块 | 需求描述 |
|---------|---------|
| 音频模块 | 支持录音和播放功能，内置麦克风和扬声器 |
| 按键 | 3-5个物理按键，用于基本操作 |
| 电源模块 | 支持Type-C充电，内置聚合物软包电池，厚度不超过3cm |
| 扩展接口 | 支持GPIO、I2C、SPI等接口，用于插件扩展 |

## 4. 软件需求

### 4.1 操作系统

| 需求描述 |
|---------|
| 支持实时操作系统，如FreeRTOS、RT-Thread等 |
| 低功耗设计，支持休眠和唤醒功能 |
| 支持WiFi连接和网络通信 |
| 支持蓝牙4.2或以上版本，用于首次WiFi配置 |

### 4.2 应用程序

| 功能模块 | 需求描述 |
|---------|---------|
| 时钟模块 | 实时显示时间、日期，支持农历转换 |
| 天气模块 | 从网络获取天气预报数据，解析和显示 |
| 传感器模块 | 读取温湿度传感器数据，存储和显示历史趋势 |
| 留言模块 | 支持文字和音频留言的接收、存储和播放 |
| 股票模块 | 从网络获取股票数据，绘制K线图 |
| 蓝牙配置模块 | 首次使用时通过蓝牙提供WiFi配置引导 |
| Web服务器模块 | 提供HTTP服务，支持浏览器访问设备设置界面（端口8080） |
| 插件管理 | 支持插件的安装、卸载和管理，通过Web页面加载插件内容 |
| Web插件加载 | 支持通过URL获取页面代码，解析显示内容、基础布局和名称，设置刷新时间 |
| 二维码生成 | 生成访问设置界面的二维码，扫码直接访问 http://ip:8080 |
| 远程通信 | 支持与手机APP或Web端的通信协议 |

### 4.3 手机APP/Web端

| 功能模块 | 需求描述 |
|---------|---------|
| 设备管理 | 支持设备的添加、删除和配置 |
| 远程控制 | 支持远程控制设备的各种功能 |
| 留言推送 | 支持文字和音频留言的推送 |
| 数据查看 | 支持查看设备的历史数据，如温湿度、股票等 |
| 插件管理 | 支持插件的下载、安装、配置和管理 |
| Web插件配置 | 支持填写插件功能页面URL，设置刷新时间（秒、分、时、天） |
| 浏览器访问 | 支持通过浏览器访问设备IP地址的8080端口，进入设备设置界面 |

## 5. 性能需求

| 性能指标 | 需求描述 |
|---------|---------|
| 响应时间 | 按键操作响应时间不超过1秒 |
| 刷新时间 | 墨水屏刷新时间不超过3秒 |
| 网络延迟 | 远程推送消息延迟不超过5秒 |
| 电池寿命 | 电池供电模式下，单次充电可使用7-15天 |
| 稳定性 | 设备连续运行30天无故障 |

## 6. 成本需求

| 版本 | 成本预算 | 续航要求 |
|------|---------|---------|
| 入门版 | 100元以下 | 30天以上 |
| 基础版 | 200元左右 | 50天以上 |
| 增强版 | 300元左右 | 150天以上 |

## 7. 扩展性需求

| 需求描述 |
|---------|
| 支持硬件扩展，可通过扩展接口添加新的传感器或模块 |
| 支持软件扩展，可通过插件机制添加新的功能 |
| 支持固件升级，可通过WiFi远程升级固件 |

## 8. 可靠性需求

| 需求描述 |
|---------|
| 设备工作温度范围：-10℃ ~ 50℃ |
| 设备工作湿度范围：10%RH ~ 90%RH |
| 抗震性能：可承受轻微震动和碰撞 |
| 抗干扰性能：可抵抗普通家庭环境中的电磁干扰 |
| 系统稳定性：设备连续运行30天无故障，无内存泄漏 |
| 异常恢复能力：单个模块故障时，系统能自动恢复或降级运行 |
| 数据完整性：传感器数据和用户数据在异常情况下不丢失 |
| 固件更新安全性：固件更新过程中支持验证和回滚，防止更新失败导致设备变砖 |

## 9. 代码优化和容错性设计

### 9.1 系统强壮性设计

| 设计要点 | 详细描述 |
|---------|---------|
| 分层异常处理 | 采用分层异常处理机制，从模块级别到系统级别都有完善的异常捕获和处理 |
| 安全模式保障 | 系统初始化失败时自动进入安全模式，保留基本功能，确保可以进行刷机或更新 |
| 看门狗机制 | 内置软件看门狗，防止系统进入死循环 |
| 内存管理优化 | 严格的内存分配和释放管理，减少内存泄漏风险 |
| 固件更新容错 | 固件更新过程中支持断点续传和验证，防止更新失败导致设备变砖 |

### 9.2 容错性设计

| 设计要点 | 详细描述 |
|---------|---------|
| 传感器容错 | 支持传感器自动检测和故障屏蔽，当某个传感器故障时自动切换到其他可用传感器或使用模拟数据 |
| 显示驱动容错 | 显示驱动异常时自动重置，确保显示功能不会完全失效 |
| 网络连接容错 | WiFi连接失败时自动重试，重试次数有限制，避免无限重试浪费电量 |
| 模块隔离机制 | 各功能模块之间通过抽象接口通信，单个模块故障不会影响其他模块运行 |
| 数据有效性验证 | 所有传感器数据和网络数据都经过有效性验证，防止无效数据导致系统崩溃 |

### 9.3 扩展性设计

| 设计要点 | 详细描述 |
|---------|---------|
| 硬件抽象接口 | 定义了统一的硬件抽象接口（如`IDisplayDriver`、`ISensorDriver`），便于添加新硬件支持 |
| 驱动工厂模式 | 采用工厂模式创建硬件驱动，新增硬件只需要实现抽象接口并注册到工厂即可 |
| 插件扩展机制 | 支持URL插件、XML/JSON/JS插件，便于快速扩展功能 |
| 模块化架构 | 清晰的模块划分，便于新功能模块的添加和集成 |
| 配置驱动设计 | 通过配置文件驱动功能，无需修改代码即可启用或禁用功能 |

### 9.4 易读性设计

| 设计要点 | 详细描述 |
|---------|---------|
| 统一命名规范 | 采用清晰的命名规范，变量、函数和类名具有描述性 |
| 详细注释 | 关键代码和复杂逻辑都有详细的注释说明 |
| 模块化结构 | 代码结构清晰，模块职责明确 |
| 设计模式应用 | 合理应用设计模式，提高代码的可理解性和可维护性 |
| 文档化设计 | 代码结构和模块关系都有文档说明，便于新开发者快速上手 |

## 10. 外观设计需求

| 需求描述 |
|---------|
| 简洁美观，适合家居环境摆放 |
| 轻薄设计，便于安装和携带 |
| 按键布局合理，操作方便 |
| 提供多种颜色和款式选择 |

## 10. 后续扩展功能

| 功能模块 | 描述 |
|---------|------|
| 智能家居控制 | 支持控制智能家居设备，如灯光、插座等 |
| 快递信息显示 | 自动获取快递信息，显示物流状态 |
| 日历提醒 | 支持添加日历提醒，显示待办事项 |
| 新闻资讯 | 显示实时新闻资讯摘要 |
| 空气质量监测 | 可选添加空气质量传感器，显示PM2.5等指标 |

## 11. 代码文件结构

### 11.1 代码文件列表

| 文件名称 | 功能描述 | 核心功能点 |
|---------|---------|-----------|
| **main.cpp** | 主程序入口 | 初始化所有模块，调度各模块循环 |
| **config.h** | 配置文件 | 定义硬件型号、网络参数、功能开关等全局配置 |
| **firmware_manager.h/cpp** | 固件管理 | TF卡更新、WiFi OTA更新、硬件自动检测、驱动适配 |
| **display_manager.h/cpp** | 显示管理 | 屏幕内容布局、页面切换、显示更新控制 |
| **display_driver.h** | 显示驱动接口 | 定义墨水屏驱动的统一接口 |
| **eink_driver.h/cpp** | 墨水屏驱动实现 | 支持多种墨水屏型号，实现显示、刷新、休眠等功能 |
| **eink_display.h/cpp** | 墨水屏显示实现 | 绘制具体的显示内容，如时间、天气、消息等 |
| **wifi_manager.h/cpp** | WiFi管理 | WiFi连接、重连、状态监测 |
| **time_manager.h/cpp** | 时间管理 | NTP时间同步、时间格式转换、农历计算 |
| **weather_manager.h/cpp** | 天气管理 | 从API获取天气数据、解析天气信息 |
| **sensor_manager.h/cpp** | 传感器管理 | 温湿度传感器数据采集、处理、存储 |
| **audio_manager.h/cpp** | 音频管理 | 音频录制、播放、音量控制 |
| **button_manager.h/cpp** | 按键管理 | 按键检测、事件处理、长按短按识别 |
| **message_manager.h/cpp** | 消息管理 | 接收、存储、显示文字/图片/音频留言 |
| **stock_manager.h/cpp** | 股票管理 | 获取股票数据、绘制K线图 |
| **plugin_manager.h/cpp** | 插件管理 | 插件加载、更新、显示 |
| **bluetooth_manager.h/cpp** | 蓝牙管理 | 蓝牙配置WiFi、设备连接 |
| **web_server.h/cpp** | Web服务器 | 提供设备管理API、消息推送接口 |
| **power_manager.h/cpp** | 电源管理 | 低功耗模式、电量监测、休眠唤醒 |
| **touch_manager.h/cpp** | 触摸管理 | 触摸事件检测、处理 |
| **camera_manager.h/cpp** | 摄像头管理 | 相机初始化、拍照、图片处理 |
| **web_client.h/cpp** | Web客户端 | 与云端服务器通信、获取更新、推送数据 |
| **ipv6_server.h/cpp** | IPv6服务器 | 支持IPv6直接访问、设备管理 |

### 11.2 代码架构设计

1. **模块化设计**：采用模块化架构，各功能模块独立封装，便于扩展和维护
2. **驱动抽象层**：通过抽象接口（如IDisplayDriver）实现硬件无关性，支持多种硬件型号
3. **事件驱动**：采用事件驱动模型，各模块通过事件进行通信，降低耦合度
4. **配置化设计**：通过config.h实现功能开关和参数调整，无需修改代码即可适配不同硬件
5. **低功耗优化**：实现了多级低功耗模式，根据设备状态自动调整功耗
6. **双模式通信**：支持IPv6直接访问和设备定时拉取两种通信方式，确保设备在各种网络环境下都能正常工作

### 11.3 核心代码流程

1. **设备启动流程**：
   - 初始化固件管理器，进行硬件自动检测
   - 初始化显示驱动和显示管理器
   - 初始化蓝牙模块，等待WiFi配置（首次启动）
   - 连接WiFi，同步时间
   - 初始化各功能模块，添加异常处理机制
   - 显示初始页面

2. **主循环流程**：
   - 处理各模块的循环任务，添加异常捕获机制
   - 根据电源管理建议更新显示，减少不必要的刷新
   - 定期更新数据（时间、天气、传感器、股票等）
   - 监控系统状态，处理异常情况

3. **固件更新流程**：
   - 检测TF卡或WiFi OTA更新
   - 下载/读取固件文件
   - 验证固件完整性
   - 执行固件更新
   - 设备重启

4. **硬件自动检测流程**：
   - 检测显示设备
   - 自动检测传感器类型，无需手动配置
   - 检测音频设备
   - 检测触摸设备
   - 检测摄像头
   - 根据检测结果适配相应驱动
   - 对不支持或故障的硬件进行降级处理，确保系统正常运行

5. **错误处理流程**：
   - 各模块添加异常处理机制，确保单个模块故障不会导致整个系统崩溃
   - 传感器数据无效时，显示降级信息
   - 显示驱动异常时，尝试重置驱动
   - WiFi连接失败时，限制重连次数，避免无限重试
   - 内存不足时，自动释放资源

6. **电源管理流程**：
   - 实时监测电池状态，根据电量调整功能
   - 无人状态自动进入低功耗模式，延长电池寿命
   - 根据显示内容优先级调整刷新频率
   - 非关键功能在低电量时自动关闭

### 11.4 代码注释规范

1. **文件头部注释**：每个文件都包含文件功能、作者、创建日期等基本信息
2. **类和函数注释**：每个类和函数都有详细的注释，说明功能、参数、返回值
3. **代码逻辑注释**：关键代码段和复杂逻辑都有详细的注释说明
4. **配置项注释**：配置文件中的每个配置项都有注释说明用途和取值范围
5. **常量和枚举注释**：常量和枚举值都有注释说明其含义

### 11.5 代码兼容性设计

1. **硬件兼容性**：支持多种ESP32系列开发板、墨水屏、传感器等硬件
2. **软件兼容性**：支持PlatformIO和Arduino IDE两种编译环境
3. **网络兼容性**：支持IPv4和IPv6网络环境
4. **跨平台设计**：代码结构清晰，便于移植到其他平台

## 12. 代码注释说明

### 12.1 注释规范

所有代码文件均严格遵循以下注释规范：

1. **文件头部注释**：包含文件功能、作者、创建日期等信息
2. **类注释**：说明类的功能、设计意图、使用方法
3. **函数注释**：包含函数功能、参数说明、返回值说明、使用示例
4. **变量注释**：说明变量的用途、取值范围、初始化方式
5. **代码块注释**：对复杂的代码逻辑进行详细说明
6. **TODO注释**：标记待完成的功能或需要优化的代码
7. **FIXME注释**：标记需要修复的bug

### 12.2 注释示例

```cpp
/**
 * @file firmware_manager.h
 * @brief 固件管理器类，负责固件更新和硬件自动检测
 * @author DIY爱好者团队
 * @date 2025-12-26
 */

/**
 * @brief 检查TF卡上是否有固件更新
 * @return bool 更新检查结果，true表示检测到有效更新
 * @note 该函数会检查TF卡根目录下的firmware.bin文件
 */
bool FirmwareManager::checkTFUpdate() {
  // 挂载TF卡
  if (!mountTF()) {
    logUpdateStatus("Failed to mount TF card");
    currentStatus = FIRMWARE_STATUS_FAILED;
    return false;
  }
  
  // 检查固件文件有效性
  if (!checkTFValidity()) {
    logUpdateStatus("No valid firmware found on TF card");
    unmountTF();
    currentStatus = FIRMWARE_STATUS_FAILED;
    return false;
  }
  
  // 执行固件更新
  if (installTFUpdate()) {
    logUpdateStatus("TF card update installed successfully");
    unmountTF();
    rebootDevice();
    return true;
  } else {
    logUpdateStatus("TF card update failed");
    unmountTF();
    currentStatus = FIRMWARE_STATUS_FAILED;
    return false;
  }
}
```