# InkClock 插件开发规范

本文档定义了 InkClock 插件系统的开发规范，帮助开发者快速创建符合要求的插件。

## 一、插件目录结构

插件必须遵循以下目录结构：

```
plugin/
├── 插件目录名/           # 插件的唯一标识，建议使用小写字母和下划线
│   ├── index.php         # 插件主文件，必须存在
│   └── [其他文件]         # 插件依赖的其他文件（可选）
└── plugin.json           # 插件配置文件（可选，用于提供插件信息）
```

### 目录命名规范
- 插件目录名必须使用小写字母、数字和下划线
- 目录名应简洁明了，能反映插件功能
- 建议使用英文命名，例如 `daily_poem`、`weather_forecast`

## 二、插件主文件（index.php）规范

### 1. 基本要求
- 文件名必须为 `index.php`
- 必须返回标准的 JSON 格式数据
- 必须设置正确的 Content-Type 响应头
- 必须处理错误情况，返回适当的错误信息

### 2. 响应格式规范

插件返回的 JSON 数据必须包含以下字段：

```json
{
  "success": true,           // 布尔值，表示请求是否成功
  "data": {
    "text": "显示文本",      // 字符串，要显示的主要文本
    "subtext": "副标题",     // 字符串，可选，副标题或补充信息
    "icon": "图标代码",       // 字符串，可选，Font Awesome 图标代码
    "color": "#颜色代码"      // 字符串，可选，文本颜色
  },
  "message": "操作成功"        // 字符串，操作结果消息
}
```

### 3. 示例代码

```php
<?php
/**
 * 每日古诗插件
 * 每天获取一首经典古诗
 */

// 设置响应头
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');

try {
    // 插件逻辑
    $poem = getDailyPoem();
    
    // 返回成功响应
    echo json_encode([
        'success' => true,
        'data' => [
            'text' => $poem['title'],
            'subtext' => $poem['author'] . '\n' . $poem['content'],
            'icon' => 'fas fa-book',
            'color' => '#4a6fa5'
        ],
        'message' => '获取成功'
    ], JSON_UNESCAPED_UNICODE);
    
exit;
} catch (Exception $e) {
    // 返回错误响应
    echo json_encode([
        'success' => false,
        'data' => [],
        'message' => '获取失败: ' . $e->getMessage()
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

/**
 * 获取每日古诗
 */
function getDailyPoem() {
    // 实现获取古诗的逻辑
    // ...
    return [
        'title' => '静夜思',
        'author' => '李白',
        'content' => '床前明月光，疑是地上霜。举头望明月，低头思故乡。'
    ];
}
```

## 三、插件配置文件（plugin.json）

`plugin.json` 文件用于提供插件的详细信息，增强插件的展示效果。

### 配置格式

```json
[
  {
    "name": "插件名称",           // 插件显示名称
    "url": "/plugin/插件目录名/index.php",  // 插件访问路径
    "description": "插件描述",     // 插件功能描述
    "refresh_interval": "更新频率", // 建议的更新频率，例如 "60分钟"
    "settings_url": "/plugin/插件目录名/index.php"  // 插件设置页面（可选）
  }
]
```

### 示例配置

```json
[
  {
    "name": "每日古诗",
    "url": "/plugin/daily_poem/index.php",
    "description": "每天获取一首经典古诗",
    "refresh_interval": "60分钟",
    "settings_url": "/plugin/daily_poem/index.php"
  },
  {
    "name": "每日英语单词",
    "url": "/plugin/daily_word/index.php",
    "description": "每天学习一个英语单词",
    "refresh_interval": "24小时",
    "settings_url": "/plugin/daily_word/index.php"
  }
]
```

## 四、插件开发最佳实践

### 1. 性能优化
- 插件执行时间应控制在 3 秒以内，避免超时
- 对于需要网络请求的插件，建议实现缓存机制
- 避免在插件中执行重���的计算操作

### 2. 错误处理
- 使用 try-catch 捕获可能的异常
- 提供详细的错误信息，便于调试
- 确保即使在错误情况下也能返回有效的 JSON 响应

### 3. 安全性
- 验证所有输入参数，防止注入攻击
- 对于网络请求，使用安全的连接（HTTPS）
- 避免在插件中存储敏感信息

### 4. 兼容性
- 确保插件代码兼容 PHP 7.0+
- 避免使用依赖外部服务的功能，确保插件可靠性
- 考虑不同网络环境下的表现

## 五、测试与调试

### 1. 本地测试
- 将插件目录放在 `plugin/` 目录下
- 直接访问插件 URL 测试返回数据格式
- 检查 JSON 格式是否正确，数据是否符合要求

### 2. 集成测试
- 在 InkClock 管理界面中添加插件
- 观察插件在设备上的显示效果
- 测试不同网络环境下的表现

## 六、插件发布

### 1. 插件提交
- 确保插件符合所有规范要求
- 提供清晰的插件描述和使用说明
- 包含必要的依赖文件和资源

### 2. 插件审核
- 系统会自动扫描新添加的插件
- 确保插件不会对系统造成安全风险
- 验证插件功能是否正常

## 七、示例插件

### 1. 每日古诗插件

**目录结构**：
```
plugin/
├── daily_poem/
│   └── index.php
└── plugin.json
```

**index.php**：
```php
<?php
/**
 * 每日古诗插件
 */

header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');

try {
    $poems = [
        [
            'title' => '静夜思',
            'author' => '李白',
            'content' => '床前明月光，疑是地上霜。举头望明月，低头思故乡。'
        ],
        [
            'title' => '望庐山瀑布',
            'author' => '李白',
            'content' => '日照香炉生紫烟，遥看瀑布挂前川。飞流直下三千尺，疑是银河落九天。'
        ]
    ];
    
    // 根据日期选择古诗
    $index = date('z') % count($poems);
    $poem = $poems[$index];
    
    echo json_encode([
        'success' => true,
        'data' => [
            'text' => $poem['title'],
            'subtext' => $poem['author'] . '\n' . $poem['content'],
            'icon' => 'fas fa-book',
            'color' => '#4a6fa5'
        ],
        'message' => '获取成功'
    ], JSON_UNESCAPED_UNICODE);
    
exit;
} catch (Exception $e) {
    echo json_encode([
        'success' => false,
        'data' => [],
        'message' => '获取失败: ' . $e->getMessage()
    ], JSON_UNESCAPED_UNICODE);
    exit;
}
```

**plugin.json**：
```json
[
  {
    "name": "每日古诗",
    "url": "/plugin/daily_poem/index.php",
    "description": "每天获取一首经典古诗",
    "refresh_interval": "60分钟",
    "settings_url": "/plugin/daily_poem/index.php"
  }
]
```

## 八、常见问题

### 1. 插件不显示在列表中
- 检查插件目录是否存在 `index.php` 文件
- 确保目录名符合命名规范
- 检查 `plugin.json` 配置是否正确

### 2. 插件返回错误
- 检查 JSON 格式是否正确
- 确保设置了正确的 Content-Type 响应头
- 查看插件代码中是否有语法错误

### 3. 插件显示异常
- 检查返回数据的格式是否符合要求
- 确保文本长度适合显示区域
- 测试不同设备上的显示效果

## 九、版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0  | 2026-01-09 | 初始版本 |

---

遵循以上规范开发的插件将能够被 InkClock 系统正确识别和使用，为用户提供丰富的功能扩展。