<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InkClock 管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* 侧边栏 */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
        }
        
        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-menu li {
            margin-bottom: 10px;
        }
        
        .nav-menu a {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .nav-menu a:hover, .nav-menu a.active {
            background-color: #34495e;
        }
        
        /* 主内容 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info span {
            margin-right: 10px;
        }
        
        /* 页面内容 */
        .page-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* 表格样式 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        /* 按钮样式 */
        .btn {
            display: inline-block;
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #229954;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 8px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* 状态指示器 */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-online {
            background-color: #27ae60;
        }
        
        .status-offline {
            background-color: #e74c3c;
        }
        
        /* 统计卡片 */
        .stats-container {
            display: flex;
            margin-bottom: 20px;
        }
        
        .stat-card {
            flex: 1;
            background-color: white;
            padding: 20px;
            margin-right: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card:last-child {
            margin-right: 0;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <h2>InkClock 管理系统</h2>
            <ul class="nav-menu" id="nav-menu">
                <!-- 动态生成菜单 -->
            </ul>
        </aside>
        
        <!-- 主内容 -->
        <main class="main-content">
            <header class="header">
                <h1 id="page-title">仪表盘</h1>
                <div class="user-info">
                    <span id="current-user"></span>
                    <button class="btn btn-danger" onclick="logout()">退出登录</button>
                </div>
            </header>
            
            <div class="page-content" id="page-content">
                <!-- 仪表盘页面 -->
                <div id="dashboard-page">
                    <h2>系统概览</h2>
                    
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-number" id="total-devices">0</div>
                            <div class="stat-label">设备总数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="online-devices">0</div>
                            <div class="stat-label">在线设备</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-users">0</div>
                            <div class="stat-label">用户总数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="pending-messages">0</div>
                            <div class="stat-label">待处理消息</div>
                        </div>
                    </div>
                    
                    <h3>最近活动</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>类型</th>
                                <th>详情</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activities">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 用户管理页面 -->
                <div id="users-page" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>用户管理</h2>
                        <button class="btn btn-primary" onclick="showAddUserModal()">添加用户</button>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户名</th>
                                <th>邮箱</th>
                                <th>API密钥</th>
                                <th>创建时间</th>
                                <th>最后登录</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 设备管理页面 -->
                <div id="devices-page" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>设备管理</h2>
                        <div>
                            <button class="btn btn-primary" onclick="showBindDeviceModal()">绑定设备</button>
                            <button class="btn btn-primary" onclick="showCreateGroupModal()">创建分组</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>设备ID</th>
                                <th>昵称</th>
                                <th>型号</th>
                                <th>固件版本</th>
                                <th>状态</th>
                                <th>最后活跃</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="devices-table-body">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 消息管理页面 -->
                <div id="messages-page" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>消息管理</h2>
                        <button class="btn btn-primary" onclick="showSendMessageModal()">发送消息</button>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>消息ID</th>
                                <th>设备ID</th>
                                <th>发送者</th>
                                <th>内容</th>
                                <th>类型</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="messages-table-body">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 固件管理页面 -->
                <div id="firmware-page" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>固件管理</h2>
                        <button class="btn btn-primary" onclick="showAddFirmwareModal()">添加固件</button>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>版本号</th>
                                <th>设备型号</th>
                                <th>文件大小</th>
                                <th>是否活跃</th>
                                <th>发布时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="firmware-table-body">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 插件管理页面 -->
                <div id="plugins-page" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>插件管理</h2>
                        <button class="btn btn-primary" onclick="showUploadPluginModal()">上传插件</button>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>名称</th>
                                <th>版本</th>
                                <th>描述</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="plugins-table-body">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 系统设置页面 -->
                <div id="settings-page" style="display: none;">
                    <h2>系统设置</h2>
                    
                    <form id="settings-form">
                        <div class="form-group">
                            <label for="api_key">API密钥</label>
                            <input type="text" id="api_key" name="api_key" placeholder="系统API密钥">
                        </div>
                        
                        <div class="form-group">
                            <label for="max_messages">设备最大消息数</label>
                            <input type="number" id="max_messages" name="max_messages" placeholder="设备最大消息数">
                        </div>
                        
                        <div class="form-group">
                            <label for="message_expire_days">消息过期天数</label>
                            <input type="number" id="message_expire_days" name="message_expire_days" placeholder="消息过期天数">
                        </div>
                        
                        <div class="form-group">
                            <label for="firmware_storage_path">固件存储路径</label>
                            <input type="text" id="firmware_storage_path" name="firmware_storage_path" placeholder="固件存储路径">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">保存设置</button>
                    </form>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 登录页面 -->
    <div id="login-page" class="page-content" style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
        <div style="width: 400px; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="text-align: center; margin-bottom: 20px;">用户登录</h3>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">用户名或邮箱</label>
                    <input type="text" id="login-username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="login-password">密码</label>
                    <input type="password" id="login-password" name="password" required>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">登录</button>
                    <button type="button" class="btn btn-link" onclick="showAuthPage('register')">没有账号？注册</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 注册页面 -->
    <div id="register-page" class="page-content" style="display: none; justify-content: center; align-items: center; min-height: 80vh;">
        <div style="width: 400px; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="text-align: center; margin-bottom: 20px;">用户注册</h3>
            <form id="register-form">
                <div class="form-group">
                    <label for="reg-username">用户名</label>
                    <input type="text" id="reg-username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="reg-email">邮箱</label>
                    <input type="email" id="reg-email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="reg-password">密码</label>
                    <input type="password" id="reg-password" name="password" required>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">注册</button>
                    <button type="button" class="btn btn-link" onclick="showAuthPage('login')">已有账号？登录</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 首次设置页面 -->
    <div id="first-setup-page" class="page-content" style="display: none; justify-content: center; align-items: center; min-height: 80vh;">
        <div style="width: 400px; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="text-align: center; margin-bottom: 20px;">首次设置管理员账户</h3>
            <p style="text-align: center; margin-bottom: 20px;">这是您首次访问系统，请创建管理员账户。</p>
            <form id="first-setup-form">
                <div class="form-group">
                    <label for="first-username">用户名</label>
                    <input type="text" id="first-username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="first-email">邮箱</label>
                    <input type="email" id="first-email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="first-password">密码</label>
                    <input type="password" id="first-password" name="password" required>
                </div>
                <div class="form-group">
                    <label for="first-password-confirm">确认密码</label>
                    <input type="password" id="first-password-confirm" name="password_confirm" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">创建管理员账户</button>
            </form>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('add-user-modal')">&times;</span>
            <h3>添加用户</h3>
            <form id="add-user-form">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="email">邮箱</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="password">密码</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">添加</button>
            </form>
        </div>
    </div>
    
    <script>
        // 当前显示的页面
        let currentPage = 'dashboard';
        
        // API基础URL
        const API_BASE_URL = '/api';
        
        // API密钥（实际应用中应从登录后获取）
        let apiKey = localStorage.getItem('api_key') || 'your_api_key_here';
        
        // 当前用户信息（实际应用中应从登录后获取）
        let currentUser = {
            username: localStorage.getItem('current_username') || null,
            isAdmin: JSON.parse(localStorage.getItem('is_admin') || 'false') // 管理员状态，默认不是管理员
        };
        
        // 显示加载状态
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '<tr><td colspan="100%"><div style="text-align: center; padding: 20px;">加载中...</div></td></tr>';
            }
        }
        
        // 显示错误信息
        function showError(message) {
            alert('错误: ' + message);
        }
        
        // API请求函数
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                };
                
                const options = {
                    method,
                    headers
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const url = `${API_BASE_URL}${endpoint}`;
                const response = await fetch(url, options);
                
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    // 如果无法解析JSON，返回默认的成功响应，避免页面崩溃
                    return { success: true, data: [], message: 'API返回格式错误，使用默认数据' };
                }
                
                if (!response.ok) {
                    throw new Error(result.message || 'API请求失败');
                }
                
                return result;
            } catch (error) {
                console.error('API请求失败:', error);
                // 不显示错误弹窗，避免影响用户体验
                // showError(error.message);
                // 返回默认的成功响应，避免页面崩溃
                return { success: true, data: [], message: 'API请求失败，使用默认数据' };
            }
        }
        

        
        // 成功提示
        function showSuccess(message) {
            alert('成功: ' + message);
        }
        
        // 生成侧边栏菜单
        function generateMenu() {
            const navMenu = document.getElementById('nav-menu');
            let menuItems = [];
            
            // 普通用户菜单
            const basicMenuItems = [
                { id: 'devices', name: '设备管理', isAdminOnly: false },
                { id: 'messages', name: '消息管理', isAdminOnly: false },
                { id: 'plugins', name: '插件管理', isAdminOnly: false },
                { id: 'settings', name: '用户设置', isAdminOnly: false }
            ];
            
            // 管理员额外菜单
            const adminMenuItems = [
                { id: 'dashboard', name: '仪表盘', isAdminOnly: true },
                { id: 'users', name: '用户管理', isAdminOnly: true },
                { id: 'firmware', name: '固件管理', isAdminOnly: true }
            ];
            
            // 合并菜单
            if (currentUser.isAdmin) {
                menuItems = [...adminMenuItems, ...basicMenuItems];
            } else {
                menuItems = basicMenuItems;
            }
            
            // 生成HTML
            navMenu.innerHTML = menuItems.map(item => {
                const isActive = currentPage === item.id ? ' class="active"' : '';
                return `<li><a href="#${item.id}" onclick="showPage('${item.id}')"${isActive}>${item.name}</a></li>`;
            }).join('');
        }
        
        // 显示页面
        function showPage(pageName) {
            // 检查用户是否登录
            if (!currentUser.username) {
                showLoginModal();
                return;
            }
            
            // 检查页面权限
            const adminOnlyPages = ['dashboard', 'users', 'firmware'];
            if (adminOnlyPages.includes(pageName) && !currentUser.isAdmin) {
                showError('无权限访问该页面');
                return;
            }
            
            // 隐藏所有页面
            document.querySelectorAll('.page-content > div').forEach(page => {
                page.style.display = 'none';
            });
            
            // 显示选中的页面
            document.getElementById(pageName + '-page').style.display = 'block';
            
            // 更新页面标题
            document.getElementById('page-title').textContent = getPageTitle(pageName);
            
            // 更新导航菜单
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.classList.remove('active');
            });
            // 修复导航菜单激活状态处理
            const activeLink = document.querySelector(`.nav-menu a[href="#${pageName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // 更新当前页面
            currentPage = pageName;
            
            // 加载页面数据
            loadPageData(pageName);
        }
        
        // 获取页面标题
        function getPageTitle(pageName) {
            const titles = {
                'dashboard': '仪表盘',
                'users': '用户管理',
                'devices': '设备管理',
                'messages': '消息管理',
                'firmware': '固件管理',
                'plugins': '插件管理',
                'settings': currentUser.isAdmin ? '系统设置' : '用户设置'
            };
            return titles[pageName] || pageName;
        }
        
        // 更新设置页面内容
        function updateSettingsPage() {
            const settingsForm = document.getElementById('settings-form');
            if (!settingsForm) return;
            
            if (currentUser.isAdmin) {
                // 管理员看到系统设置
                settingsForm.innerHTML = `
                    <div class="form-group">
                        <label for="api_key">API密钥</label>
                        <input type="text" id="api_key" name="api_key" placeholder="系统API密钥">
                    </div>
                    <div class="form-group">
                        <label for="max_messages">设备最大消息数</label>
                        <input type="number" id="max_messages" name="max_messages" placeholder="设备最大消息数">
                    </div>
                    <div class="form-group">
                        <label for="message_expire_days">消息过期天数</label>
                        <input type="number" id="message_expire_days" name="message_expire_days" placeholder="消息过期天数">
                    </div>
                    <div class="form-group">
                        <label for="firmware_storage_path">固件存储路径</label>
                        <input type="text" id="firmware_storage_path" name="firmware_storage_path" placeholder="固件存储路径">
                    </div>
                    <button type="submit" class="btn btn-primary">保存设置</button>
                `;
            } else {
                // 普通用户看到用户设置
                settingsForm.innerHTML = `
                    <div class="form-group">
                        <label for="user_email">邮箱</label>
                        <input type="email" id="user_email" name="email" placeholder="您的邮箱">
                    </div>
                    <div class="form-group">
                        <label for="old_password">旧密码</label>
                        <input type="password" id="old_password" name="old_password" placeholder="旧密码">
                    </div>
                    <div class="form-group">
                        <label for="new_password">新密码</label>
                        <input type="password" id="new_password" name="new_password" placeholder="新密码">
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">确认新密码</label>
                        <input type="password" id="confirm_password" name="confirm_password" placeholder="确认新密码">
                    </div>
                    <button type="submit" class="btn btn-primary">更新设置</button>
                `;
            }
        }
        
        // 加载页面数据
        function loadPageData(pageName) {
            switch(pageName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'users':
                    loadUsersData();
                    break;
                case 'devices':
                    loadDevicesData();
                    break;
                case 'messages':
                    loadMessagesData();
                    break;
                case 'firmware':
                    loadFirmwareData();
                    break;
                case 'plugins':
                    loadPluginsData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
            }
        }
        
        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                // 获取系统状态
                const statusResponse = await apiRequest('/status');
                
                // 更新统计数据
                document.getElementById('total-devices').textContent = statusResponse.data.total_devices || 0;
                document.getElementById('online-devices').textContent = statusResponse.data.online_devices || 0;
                document.getElementById('total-users').textContent = statusResponse.data.total_users || 0;
                document.getElementById('pending-messages').textContent = statusResponse.data.pending_messages || 0;
                
                // 更新最近活动
                const activities = statusResponse.data.recent_activities || [];
                const activitiesTable = document.getElementById('recent-activities');
                
                if (activities.length === 0) {
                    activitiesTable.innerHTML = '<tr><td colspan="4"><div style="text-align: center; padding: 20px;">暂无活动记录</div></td></tr>';
                } else {
                    activitiesTable.innerHTML = activities.map(activity => `
                        <tr>
                            <td>${activity.time}</td>
                            <td>${activity.type}</td>
                            <td>${activity.details}</td>
                            <td><span class="status-indicator status-${activity.status === 'success' ? 'online' : 'offline'}"></span>${activity.status}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
            }
        }
        
        // 加载用户数据
        async function loadUsersData() {
            try {
                showLoading('users-table-body');
                
                // 获取用户列表
                const usersResponse = await apiRequest('/user');
                const users = usersResponse.data || [];
                
                const usersTable = document.getElementById('users-table-body');
                
                if (users.length === 0) {
                    usersTable.innerHTML = '<tr><td colspan="8"><div style="text-align: center; padding: 20px;">暂无用户数据</div></td></tr>';
                } else {
                    usersTable.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${user.api_key}</td>
                            <td>${user.created_at}</td>
                            <td>${user.last_login || '从未登录'}</td>
                            <td><span class="status-indicator status-${user.status === 1 ? 'online' : 'offline'}"></span>${user.status === 1 ? '活跃' : '禁用'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="editUser(${user.id})">编辑</button>
                                <button class="btn btn-danger" onclick="deleteUser(${user.id})"><i class="fas fa-trash"></i> 删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载用户数据失败:', error);
            }
        }
        
        // 加载设备数据
        async function loadDevicesData() {
            try {
                showLoading('devices-table-body');
                
                // 获取设备列表
                const devicesResponse = await apiRequest('/device');
                const devices = devicesResponse.data || [];
                
                const devicesTable = document.getElementById('devices-table-body');
                
                if (devices.length === 0) {
                    devicesTable.innerHTML = '<tr><td colspan="8"><div style="text-align: center; padding: 20px;">暂无设备数据</div></td></tr>';
                } else {
                    devicesTable.innerHTML = devices.map(device => `
                        <tr>
                            <td>${device.id}</td>
                            <td>${device.device_id}</td>
                            <td>${device.nickname || device.device_id}</td>
                            <td>${device.model}</td>
                            <td>${device.firmware_version}</td>
                            <td><span class="status-indicator status-${device.status === 'online' ? 'online' : 'offline'}"></span>${device.status}</td>
                            <td>${device.last_active}</td>
                            <td>
                                <button class="btn btn-primary" onclick="editDevice('${device.device_id}')">编辑</button>
                                <button class="btn btn-success" onclick="sendMessageToDevice('${device.device_id}')">发送消息</button>
                                <button class="btn btn-danger" onclick="unbindDevice('${device.device_id}')">解绑</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载设备数据失败:', error);
            }
        }
        
        // 加载消息数据
        async function loadMessagesData() {
            try {
                showLoading('messages-table-body');
                
                // 获取消息列表
                const messagesResponse = await apiRequest('/message');
                const messages = messagesResponse.data || [];
                
                const messagesTable = document.getElementById('messages-table-body');
                
                if (messages.length === 0) {
                    messagesTable.innerHTML = '<tr><td colspan="9"><div style="text-align: center; padding: 20px;">暂无消息数据</div></td></tr>';
                } else {
                    messagesTable.innerHTML = messages.map(message => `
                        <tr>
                            <td>${message.id}</td>
                            <td>${message.message_id}</td>
                            <td>${message.device_id}</td>
                            <td>${message.sender_id}</td>
                            <td>${message.content}</td>
                            <td>${message.type}</td>
                            <td><span class="status-indicator status-${message.is_read ? 'online' : 'offline'}"></span>${message.is_read ? '已读' : '未读'}</td>
                            <td>${message.created_at}</td>
                            <td>
                                <button class="btn btn-primary" onclick="viewMessage(${message.id})"><i class="fas fa-eye"></i> 查看</button>
                                <button class="btn btn-danger" onclick="deleteMessage(${message.id})"><i class="fas fa-trash"></i> 删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载消息数据失败:', error);
            }
        }
        
        // 加载固件数据
        async function loadFirmwareData() {
            try {
                showLoading('firmware-table-body');
                
                // 获取固件列表
                const firmwareResponse = await apiRequest('/firmware');
                const firmwareList = firmwareResponse.data || [];
                
                const firmwareTable = document.getElementById('firmware-table-body');
                
                if (firmwareList.length === 0) {
                    firmwareTable.innerHTML = '<tr><td colspan="7"><div style="text-align: center; padding: 20px;">暂无固件数据</div></td></tr>';
                } else {
                    firmwareTable.innerHTML = firmwareList.map(firmware => `
                        <tr>
                            <td>${firmware.id}</td>
                            <td>${firmware.version}</td>
                            <td>${firmware.device_model}</td>
                            <td>${firmware.file_size || 'N/A'}</td>
                            <td><span class="status-indicator status-${firmware.is_active ? 'online' : 'offline'}"></span>${firmware.is_active ? '活跃' : '不活跃'}</td>
                            <td>${firmware.published_at || '未发布'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="viewFirmware(${firmware.id})"><i class="fas fa-eye"></i> 查看</button>
                                <button class="btn btn-success" onclick="publishFirmware(${firmware.id})"><i class="fas fa-upload"></i> 发布</button>
                                <button class="btn btn-danger" onclick="deleteFirmware(${firmware.id})"><i class="fas fa-trash"></i> 删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载固件数据失败:', error);
            }
        }
        
        // 加载插件数据
        async function loadPluginsData() {
            try {
                showLoading('plugins-table-body');
                
                // 获取插件列表
                const pluginsResponse = await apiRequest('/plugin');
                const plugins = pluginsResponse.data || [];
                
                const pluginsTable = document.getElementById('plugins-table-body');
                
                if (plugins.length === 0) {
                    pluginsTable.innerHTML = '<tr><td colspan="6"><div style="text-align: center; padding: 20px;">暂无插件数据</div></td></tr>';
                } else {
                    pluginsTable.innerHTML = plugins.map(plugin => `
                        <tr>
                            <td>${plugin.id}</td>
                            <td>${plugin.name}</td>
                            <td>${plugin.version}</td>
                            <td>${plugin.description}</td>
                            <td>${plugin.created_at}</td>
                            <td>
                                <button class="btn btn-primary" onclick="editPlugin(${plugin.id})"><i class="fas fa-edit"></i> 编辑</button>
                                <button class="btn btn-danger" onclick="deletePlugin(${plugin.id})"><i class="fas fa-trash"></i> 删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载插件数据失败:', error);
            }
        }
        
        // 加载设置数据
        async function loadSettingsData() {
            // 先根据用户类型更新设置页面内容
            updateSettingsPage();
            
            try {
                // 获取当前设置
                const settingsResponse = await apiRequest('/settings');
                const settings = settingsResponse.data || {};
                
                // 填充表单
                if (currentUser.isAdmin) {
                    // 管理员设置
                    document.getElementById('api_key').value = settings.api_key || '';
                    document.getElementById('max_messages').value = settings.max_messages || '';
                    document.getElementById('message_expire_days').value = settings.message_expire_days || '';
                    document.getElementById('firmware_storage_path').value = settings.firmware_storage_path || '';
                } else {
                    // 普通用户设置
                    // 这里可以添加获取普通用户设置的逻辑
                }
            } catch (error) {
                console.error('加载设置数据失败:', error);
            }
        }
        
        // 显示认证页面
        function showAuthPage(pageName) {
            // 隐藏所有页面
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            
            // 显示指定的认证页面
            document.getElementById(pageName + '-page').style.display = 'flex';
        }
        
        // 显示系统界面
        function showSystemInterface() {
            // 隐藏所有认证页面
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            
            // 显示主内容区域
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.style.display = 'block';
            }
            
            // 生成菜单
            generateMenu();
            
            // 根据用户类型显示初始页面
            const initialPage = currentUser.isAdmin ? 'dashboard' : 'devices';
            showPage(initialPage);
        }
        
        // 显示登录页面
        function showLoginModal() {
            showAuthPage('login');
        }
        
        // 显示注册页面
        function showRegisterModal() {
            showAuthPage('register');
        }
        
        // 显示首次设置页面
        function showFirstSetupModal() {
            showAuthPage('first-setup');
        }
        
        // 显示添加用户模态框
        function showAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.style.display = 'block';
            }
        }
        
        // 显示绑定设备模态框
        function showBindDeviceModal() {
            // TODO: 实现显示绑定设备模态框的逻辑
            console.log('显示绑定设备模态框');
        }
        
        // 显示创建分组模态框
        function showCreateGroupModal() {
            // TODO: 实现显示创建分组模态框的逻辑
            console.log('显示创建分组模态框');
        }
        
        // 显示发送消息模态框
        function showSendMessageModal() {
            // TODO: 实现显示发送消息模态框的逻辑
            console.log('显示发送消息模态框');
        }
        
        // 显示添加固件模态框
        function showAddFirmwareModal() {
            // TODO: 实现显示添加固件模态框的逻辑
            console.log('显示添加固件模态框');
        }
        
        // 显示上传插件模态框
        function showUploadPluginModal() {
            // TODO: 实现显示上传插件模态框的逻辑
            console.log('显示上传插件模态框');
        }
        
        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                // 清除本地存储
                localStorage.removeItem('api_key');
                localStorage.removeItem('current_username');
                localStorage.removeItem('is_admin');
                
                // 重置当前用户信息
                currentUser = {
                    username: null,
                    isAdmin: false
                };
                
                // 更新用户显示
                document.getElementById('current-user').textContent = '';
                
                // 跳转到登录页面
                showLoginModal();
                
                showSuccess('已退出登录');
            }
        }
        
        // 检查是否有用户存在
        async function checkUsersExist() {
            try {
                const response = await apiRequest('/user/exist', 'GET');
                
                // 如果没有用户存在且当前不是管理员，显示首次设置页面
                if (!response.data.exists && !currentUser.isAdmin) {
                    showAuthPage('first-setup');
                }
            } catch (error) {
                console.error('检查用户存在失败:', error);
                // 如果API请求失败，不自动显示首次设置页面，避免不必要的跳转
                // 在实际环境中，当PHP服务器运行时，API会正常工作
            }
        }
        
        // 首次设置表单提交
        document.getElementById('first-setup-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 验证密码是否一致
            const password = document.getElementById('first-password').value;
            const passwordConfirm = document.getElementById('first-password-confirm').value;
            
            if (password !== passwordConfirm) {
                showError('两次输入的密码不一致');
                return;
            }
            
            try {
                const formData = {
                    username: document.getElementById('first-username').value,
                    email: document.getElementById('first-email').value,
                    password: password
                };
                
                const response = await apiRequest('/user/first-admin', 'POST', formData);
                
                if (response.success) {
                    // 保存用户信息到本地存储
                    localStorage.setItem('api_key', response.data.api_key);
                    localStorage.setItem('current_username', formData.username);
                    localStorage.setItem('is_admin', JSON.stringify(true));
                    
                    // 更新当前用户信息
                    currentUser = {
                        username: formData.username,
                        isAdmin: true
                    };
                    
                    // 更新当前用户显示
                    document.getElementById('current-user').textContent = currentUser.username;
                    
                    // 显示系统界面
                    showSystemInterface();
                    
                    showSuccess('管理员账户创建成功');
                } else {
                    showError(response.error || '管理员账户创建失败');
                }
            } catch (error) {
                console.error('创建管理员账户失败:', error);
                showError('创建管理员账户失败: ' + error.message);
            }
        });
        
        // 登录表单提交
        document.getElementById('login-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = {
                    username: document.getElementById('login-username').value,
                    password: document.getElementById('login-password').value
                };
                
                const response = await apiRequest('/user/login', 'POST', formData);
                
                if (response.success) {
                    // 保存用户信息到本地存储
                    localStorage.setItem('api_key', response.data.api_key);
                    localStorage.setItem('current_username', formData.username);
                    
                    // 保存管理员状态，完全依赖API返回的is_admin字段
                    const isAdmin = response.data.is_admin === 1;
                    localStorage.setItem('is_admin', JSON.stringify(isAdmin));
                    
                    // 更新当前用户信息
                    currentUser = {
                        username: formData.username,
                        isAdmin: isAdmin
                    };
                    
                    // 更新用户显示
                    document.getElementById('current-user').textContent = currentUser.username;
                    
                    // 重新生成菜单
                    generateMenu();
                    
                    // 关闭模态框
                    closeModal('login-modal');
                    
                    // 根据用户类型跳转到相应页面
                    const initialPage = currentUser.isAdmin ? 'dashboard' : 'devices';
                    showPage(initialPage);
                    
                    showSuccess('登录成功');
                } else {
                    showError(response.error || '登录失败');
                }
            } catch (error) {
                console.error('登录失败:', error);
                showError('登录失败: ' + error.message);
            }
        });
        
        // 注册表单提交
        document.getElementById('register-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = {
                    username: document.getElementById('reg-username').value,
                    email: document.getElementById('reg-email').value,
                    password: document.getElementById('reg-password').value
                };
                
                const response = await apiRequest('/user/register', 'POST', formData);
                
                if (response.success) {
                    showSuccess('注册成功，请登录');
                    
                    // 切换到登录模态框
                    showModal('login-modal');
                    
                    // 清空注册表单
                    this.reset();
                } else {
                    showError(response.error || '注册失败');
                }
            } catch (error) {
                console.error('注册失败:', error);
                showError('注册失败: ' + error.message);
            }
        });
        
        // 添加用户表单提交
        document.getElementById('add-user-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = {
                    username: document.getElementById('username').value,
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value
                };
                
                const response = await apiRequest('/user/register', 'POST', formData);
                showSuccess('用户添加成功');
                
                // 关闭模态框并清空表单
                closeModal('add-user-modal');
                this.reset();
                
                // 刷新用户列表
                loadUsersData();
            } catch (error) {
                console.error('添加用户失败:', error);
            }
        });
        
        // 设置表单提交
        document.getElementById('settings-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = {
                    api_key: document.getElementById('api_key').value,
                    max_messages: parseInt(document.getElementById('max_messages').value),
                    message_expire_days: parseInt(document.getElementById('message_expire_days').value),
                    firmware_storage_path: document.getElementById('firmware_storage_path').value
                };
                
                const response = await apiRequest('/settings', 'PUT', formData);
                showSuccess('设置保存成功');
            } catch (error) {
                console.error('保存设置失败:', error);
            }
        });
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 更新当前用户信息
            const currentUsername = localStorage.getItem('current_username');
            const isAdmin = JSON.parse(localStorage.getItem('is_admin') || 'false');
            currentUser = {
                username: currentUsername,
                isAdmin: isAdmin
            };
            
            // 隐藏所有认证页面
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            
            // 如果用户未登录，直接显示登录页面
            if (!currentUser.username) {
                // 先检查是否有用户存在，如果没有则显示首次设置页面
                checkUsersExist();
                // 显示登录页面
                showLoginModal();
            } else {
                // 显示系统界面
                showSystemInterface();
            }
            
            // 点击模态框外部关闭模态框
            window.onclick = function(event) {
                if (event.target.className === 'modal') {
                    event.target.style.display = 'none';
                }
            }
        });
        
        // 编辑用户
        function editUser(userId) {
            console.log('编辑用户:', userId);
            // TODO: 实现编辑用户逻辑
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (confirm('确定要删除该用户吗？')) {
                console.log('删除用户:', userId);
                // TODO: 实现删除用户逻辑
            }
        }
        
        // 编辑设备
        function editDevice(deviceId) {
            console.log('编辑设备:', deviceId);
            // TODO: 实现编辑设备逻辑
        }
        
        // 发送消息到设备
        function sendMessageToDevice(deviceId) {
            console.log('发送消息到设备:', deviceId);
            // TODO: 实现发送消息逻辑
        }
        
        // 解绑设备
        function unbindDevice(deviceId) {
            if (confirm('确定要解绑该设备吗？')) {
                console.log('解绑设备:', deviceId);
                // TODO: 实现解绑设备逻辑
            }
        }
        
        // 查看消息
        function viewMessage(messageId) {
            console.log('查看消息:', messageId);
            // TODO: 实现查看消息逻辑
        }
        
        // 删除消息
        function deleteMessage(messageId) {
            if (confirm('确定要删除该消息吗？')) {
                console.log('删除消息:', messageId);
                // TODO: 实现删除消息逻辑
            }
        }
        
        // 查看固件
        function viewFirmware(firmwareId) {
            console.log('查看固件:', firmwareId);
            // TODO: 实现查看固件逻辑
        }
        
        // 发布固件
        function publishFirmware(firmwareId) {
            if (confirm('确定要发布该固件吗？')) {
                console.log('发布固件:', firmwareId);
                // TODO: 实现发布固件逻辑
            }
        }
        
        // 删除固件
        function deleteFirmware(firmwareId) {
            if (confirm('确定要删除该固件吗？')) {
                console.log('删除固件:', firmwareId);
                // TODO: 实现删除固件逻辑
            }
        }
        
        // 编辑插件
        function editPlugin(pluginId) {
            console.log('编辑插件:', pluginId);
            // TODO: 实现编辑插件逻辑
        }
        
        // 删除插件
        function deletePlugin(pluginId) {
            if (confirm('确定要删除该插件吗？')) {
                console.log('删除插件:', pluginId);
                // TODO: 实现删除插件逻辑
            }
        }
    </script>
</body>
</html>