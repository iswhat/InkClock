# InkClock Web Server 需求文档

## 1. 系统概述

InkClock Web Server是一个为墨水屏时钟设备设计的Web服务端，提供设备管理、消息推送、固件更新、插件管理等功能。系统采用模块化MVC架构，具有良好的可扩展性、可维护性和安全性。

## 2. 功能需求

### 2.1 核心功能

| 功能模块 | 详细需求 | 实现状态 |
|----------|----------|----------|
| 用户管理 | - 多用户支持<br>- 用户注册、登录<br>- 用户权限管理<br>- 用户绑定设备 | ✅ 已实现 |
| 设备管理 | - 设备注册<br>- 设备状态监控<br>- 设备分组管理<br>- 设备标签功能 | ✅ 已实现 |
| 消息管理 | - 消息发送<br>- 消息模板<br>- 批量消息发送<br>- 定时消息发送 | ✅ 已实现 |
| 固件管理 | - 固件上传<br>- 固件版本管理<br>- 固件推送策略<br>- 固件更新状态监控 | ✅ 已实现 |
| 插件管理 | - 插件上传、审核、发布<br>- 插件版本管理<br>- 插件市场功能<br>- 插件评分和评论 | ✅ 已实现 |
| 通知系统 | - 设备离线告警<br>- 固件更新失败告警<br>- 系统异常告警<br>- 多渠道告警通知 | ✅ 已实现 |
| 设备影子 | - 设备状态同步和持久化<br>- 设备离线命令缓存<br>- 设备状态历史记录 | ✅ 已实现 |
| 自动化规则 | - 基于条件的自动化规则<br>- 基于时间的自动化规则<br>- 设备状态触发规则 | ✅ 已实现 |

### 2.2 Web管理界面

| 界面模块 | 详细需求 | 实现状态 |
|----------|----------|----------|
| 系统概览 | - 设备在线状态统计<br>- 固件更新成功率统计<br>- 消息发送量统计<br>- 系统健康状态 | ✅ 已实现 |
| 用户管理页面 | - 用户列表展示<br>- 用户创建、编辑、删除<br>- 用户权限设置 | ✅ 已实现 |
| 设备管理页面 | - 设备列表展示<br>- 设备详情查看<br>- 设备分组管理<br>- 设备标签管理 | ✅ 已实现 |
| 消息管理页面 | - 消息列表展示<br>- 消息发送<br>- 消息模板管理<br>- 消息状态监控 | ✅ 已实现 |
| 固件管理页面 | - 固件列表展示<br>- 固件上传<br>- 固件推送任务管理<br>- 固件更新状态监控 | ✅ 已实现 |
| 插件管理页面 | - 插件列表展示<br>- 插件上传、审核<br>- 插件版本管理<br>- 插件市场浏览 | ✅ 已实现 |

## 3. 非功能需求

### 3.1 性能需求

| 需求项 | 详细要求 |
|--------|----------|
| 响应时间 | API响应时间 < 500ms<br>页面加载时间 < 2s |
| 并发处理 | 支持至少100个并发设备连接<br>支持至少10个并发Web管理用户 |
| 数据处理 | 每分钟处理至少1000条消息<br>支持至少10000台设备管理 |

### 3.2 可靠性需求

| 需求项 | 详细要求 |
|--------|----------|
| 系统可用性 | 99.5%以上 |
| 数据完整性 | 确保设备数据、消息、固件的完整性和一致性 |
| 错误处理 | 完善的错误日志和异常处理机制 |
| 故障恢复 | 支持数据备份和恢复<br>系统故障自动重启机制 |

### 3.3 安全性需求

| 需求项 | 详细要求 | 实现状态 |
|--------|----------|----------|
| 认证机制 | - 用户名密码认证<br>- 双因素认证<br>- API密钥认证 | ✅ 已实现 |
| 授权机制 | - 基于角色的权限控制<br>- 设备访问权限控制 | ✅ 已实现 |
| 数据安全 | - 敏感数据加密存储<br>- HTTPS支持 | ✅ 已实现 |
| 访问控制 | - IP白名单<br>- 登录失败次数限制 | ✅ 已实现 |
| 审计日志 | - 记录关键操作日志<br>- 支持日志查询和分析 | ✅ 已实现 |

### 3.4 可扩展性需求

| 需求项 | 详细要求 | 实现状态 |
|--------|----------|----------|
| 模块化设计 | - 清晰的模块划分<br>- 松耦合的组件设计 | ✅ 已实现 |
| API扩展 | - RESTful API设计<br>- 支持API版本控制 | ✅ 已实现 |
| 插件机制 | - 支持动态加载插件<br>- 插件API规范 | ✅ 已实现 |
| 配置管理 | - 集中式配置<br>- 支持环境变量配置 | ✅ 已实现 |

### 3.5 可维护性需求

| 需求项 | 详细要求 | 实现状态 |
|--------|----------|----------|
| 代码质量 | - 清晰的代码结构<br>- 规范的代码风格<br>- 完整的注释 | ✅ 已实现 |
| 日志系统 | - 分级日志记录<br>- 日志文件自动旋转<br>- 支持日志查询 | ✅ 已实现 |
| 监控系统 | - 系统性能监控<br>- 设备状态监控<br>- 错误告警 | ✅ 已实现 |
| 文档 | - 详细的API文档<br>- 系统架构文档<br>- 部署和维护文档 | ✅ 已实现 |

## 4. 技术需求

### 4.1 硬件需求

| 设备类型 | 配置要求 |
|----------|----------|
| 服务器 | CPU: 2核以上<br>内存: 4GB以上<br>存储: 50GB以上可用空间 |
| 网络 | 稳定的网络连接<br>带宽: 10Mbps以上 |

### 4.2 软件需求

| 软件组件 | 版本要求 |
|----------|----------|
| 操作系统 | Windows Server 2016+<br>Linux (Ubuntu 18.04+ / CentOS 7+)<br>macOS 10.13+ |
| Web服务器 | Apache 2.4+<br>Nginx 1.16+ |
| PHP | PHP 7.0+<br>推荐版本: PHP 7.4+ |
| 数据库 | MySQL 5.7+<br>推荐版本: MySQL 8.0+<br>MariaDB 10.3+ |
| 浏览器 | Chrome 80+<br>Firefox 75+<br>Safari 13+<br>Edge 80+ |

### 4.3 PHP扩展需求

| 扩展名称 | 用途 | 必须/可选 |
|----------|------|----------|
| PDO | 数据库访问 | 必须 |
| mysqli | MySQL数据库驱动 | 必须 |
| json | JSON数据处理 | 必须 |
| openssl | 数据加密和HTTPS支持 | 必须 |
| fileinfo | 文件类型检测 | 必须 |
| mbstring | 多字节字符串处理 | 必须 |
| curl | HTTP请求处理 | 可选 |
| gd | 图像处理 | 可选 |

## 5. 系统架构

### 5.1 架构设计

系统采用模块化MVC架构，主要包含以下核心组件：

1. **控制器层** (`api/`)
   - 处理HTTP请求
   - 调用业务逻辑
   - 返回统一格式的响应

2. **模型层** (`models/`)
   - 数据访问层
   - 封装数据库操作
   - 业务实体定义

3. **配置层** (`config/`)
   - 集中式配置管理
   - 路由配置
   - 环境变量支持

4. **工具类** (`utils/`)
   - 数据库连接管理
   - 统一响应处理
   - 日志记录

5. **插件系统** (`plugin/`)
   - 支持动态加载插件
   - 插件市场功能

### 5.2 技术架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   前端界面      │────▶│   API控制器     │────▶│   业务逻辑      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                 │                       ▲
                                 ▼                       │
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   设备客户端    │────▶│   自动路由系统   │────▶│   数据模型      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                 │                       ▲
                                 ▼                       │
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   插件客户端    │────▶│   中间件系统     │────▶│   数据库访问    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 6. 数据模型

### 6.1 核心数据模型

| 模型名称 | 主要字段 | 用途 |
|----------|----------|------|
| User | id, username, password, email, created_at, updated_at | 用户信息 |
| Device | id, device_id, user_id, name, model, version, status, created_at, updated_at | 设备信息 |
| DeviceGroup | id, name, user_id, created_at, updated_at | 设备分组 |
| DeviceTag | id, device_id, tag, created_at | 设备标签 |
| Message | id, device_id, content, type, status, created_at, updated_at | 消息记录 |
| MessageTemplate | id, name, content, type, created_at, updated_at | 消息模板 |
| FirmwareVersion | id, version, filename, size, description, created_at | 固件版本 |
| FirmwarePushTask | id, firmware_id, target_type, target_ids, status, created_at, updated_at | 固件推送任务 |
| Notification | id, user_id, type, content, status, created_at | 通知记录 |
| SystemLog | id, level, message, context, created_at | 系统日志 |

## 7. API需求

### 7.1 API设计原则

- 遵循RESTful设计原则
- 使用JSON格式进行数据交换
- 统一的错误响应格式
- 支持CORS跨域请求
- 完善的认证和授权机制

### 7.2 主要API端点

| API模块 | 主要端点 |
|---------|----------|
| 用户管理 | GET /api/user<br>POST /api/user<br>GET /api/user/{id}<br>PUT /api/user/{id}<br>DELETE /api/user/{id} |
| 设备管理 | GET /api/device<br>POST /api/device<br>GET /api/device/{deviceId}<br>PUT /api/device/{deviceId}<br>DELETE /api/device/{deviceId} |
| 消息管理 | GET /api/message<br>POST /api/message<br>GET /api/message/{deviceId}<br>PUT /api/message/{id} |
| 固件管理 | GET /api/firmware<br>POST /api/firmware<br>GET /api/firmware/{id}<br>DELETE /api/firmware/{id} |
| 插件管理 | GET /api/plugin<br>POST /api/plugin<br>GET /api/plugin/{id}<br>DELETE /api/plugin/{id} |

## 8. 部署需求

### 8.1 部署环境

| 环境类型 | 配置要求 |
|----------|----------|
| 开发环境 | PHP 7.4+<br>MySQL 8.0+<br>本地Web服务器 |
| 测试环境 | PHP 7.4+<br>MySQL 8.0+<br>独立测试服务器 |
| 生产环境 | PHP 7.4+<br>MySQL 8.0+<br>高性能Web服务器<br>负载均衡（可选） |

### 8.2 部署步骤

1. **环境准备**
   - 安装Web服务器（Apache/Nginx）
   - 安装PHP和必要的扩展
   - 安装MySQL数据库

2. **代码部署**
   - 上传代码到服务器
   - 配置文件权限
   - 配置Web服务器虚拟主机

3. **数据库初始化**
   - 创建数据库
   - 导入初始化SQL脚本
   - 配置数据库连接

4. **系统配置**
   - 配置系统参数
   - 配置日志和缓存
   - 配置安全设置

5. **测试验证**
   - 功能测试
   - 性能测试
   - 安全性测试

## 9. 测试需求

### 9.1 测试类型

| 测试类型 | 测试内容 |
|----------|----------|
| 单元测试 | 核心功能单元测试<br>API端点测试<br>数据模型测试 |
| 集成测试 | 模块间集成测试<br>数据库交互测试<br>系统流程测试 |
| 功能测试 | 用户功能测试<br>设备管理测试<br>消息发送测试<br>固件更新测试 |
| 性能测试 | 响应时间测试<br>并发处理测试<br>数据处理能力测试 |
| 安全性测试 | 认证授权测试<br>数据加密测试<br>漏洞扫描测试 |
| 兼容性测试 | 浏览器兼容性测试<br>PHP版本兼容性测试<br>数据库兼容性测试 |

### 9.2 测试工具

| 测试类型 | 推荐工具 |
|----------|----------|
| 单元测试 | PHPUnit<br>Codeception |
| API测试 | Postman<br>Insomnia<br>Swagger UI |
| 性能测试 | Apache JMeter<br>LoadRunner |
| 安全性测试 | OWASP ZAP<br>Burp Suite |
| 代码质量 | PHP_CodeSniffer<br>PHPStan<br>Psalm |

## 10. 维护需求

### 10.1 日常维护

| 维护项 | 频率 | 责任人 |
|--------|------|--------|
| 系统监控 | 实时 | 系统管理员 |
| 日志分析 | 每日 | 系统管理员 |
| 数据库备份 | 每日 | 系统管理员 |
| 安全检查 | 每周 | 安全管理员 |
| 性能优化 | 每月 | 开发团队 |

### 10.2 版本更新

| 更新类型 | 流程 |
|----------|------|
| 功能更新 | 需求分析 → 开发 → 测试 → 部署 → 验证 |
| 安全补丁 | 漏洞评估 → 修复 → 测试 → 紧急部署 |
| 性能优化 | 性能分析 → 优化 → 测试 → 部署 |

## 11. 项目计划

### 11.1 实施阶段

| 阶段 | 时间 | 主要任务 |
|------|------|----------|
| 阶段1：基础架构重构 | 已完成 | 目录结构优化<br>自动路由系统<br>中间件机制<br>单例Database类<br>统一Response处理<br>多级别Logger |
| 阶段2：控制器和服务实现 | 已完成 | 实现13个控制器类<br>实现11个数据模型<br>实现自动路由配置<br>实现RESTful API设计 |
| 阶段3：功能完善和文档 | 已完成 | 实现完整的API端点<br>实现统一的错误处理机制<br>实现增强的日志系统<br>实现CORS处理<br>实现集中式配置管理<br>优化前端界面和用户体验 |
| 阶段4：测试和优化 | 进行中 | 代码语法检查<br>架构设计验证<br>前端功能验证 |
| 阶段5：部署和上线 | 待执行 | 生产环境部署<br>系统监控配置<br>性能优化 |

### 11.2 后续计划

| 计划项 | 优先级 | 预计时间 |
|--------|--------|----------|
| 服务层完善 | 中 | 2周 |
| 单元测试 | 中 | 3周 |
| 性能优化 | 高 | 2周 |
| API文档自动化 | 中 | 1周 |
| 多语言支持 | 低 | 4周 |
| 容器化部署 | 中 | 3周 |
| CI/CD集成 | 低 | 4周 |

## 12. 风险评估

| 风险项 | 影响程度 | 可能性 | 应对措施 |
|--------|----------|--------|----------|
| PHP版本兼容性问题 | 高 | 中 | 开发时兼容多个PHP版本<br>使用兼容性测试工具 |
| 数据库性能瓶颈 | 高 | 中 | 优化数据库查询<br>添加索引<br>考虑分库分表 |
| 安全漏洞 | 高 | 低 | 定期安全审计<br>及时更新补丁<br>使用安全开发实践 |
| 系统扩展性问题 | 中 | 中 | 采用模块化设计<br>预留扩展接口<br>定期架构评审 |
| 设备连接稳定性 | 中 | 高 | 实现设备重连机制<br>优化网络传输<br>添加连接池管理 |

## 13. 附录

### 13.1 术语定义

| 术语 | 解释 |
|------|------|
| MVC | Model-View-Controller，一种软件设计模式 |
| RESTful | 一种软件架构风格，用于设计网络应用程序的API |
| 设备影子 | 设备状态的数字孪生，用于设备离线时的状态同步 |
| 固件OTA | Over-the-Air，通过网络进行固件更新 |
| CORS | Cross-Origin Resource Sharing，跨域资源共享 |
| JWT | JSON Web Token，一种用于身份验证的令牌格式 |

### 13.2 参考文档

- [PHP官方文档](https://www.php.net/docs.php)
- [MySQL官方文档](https://dev.mysql.com/doc/)
- [RESTful API设计指南](https://restfulapi.net/)
- [OWASP安全开发指南](https://owasp.org/www-project-secure-coding-practices-quick-reference-guide/)

### 13.3 联系方式

- 项目负责人：[负责人姓名]
- 技术支持：[支持邮箱]
- 问题反馈：[反馈渠道]
- 文档更新：[更新日志]

---

**文档版本**：v1.0
**最后更新**：2025-12-31
**更新说明**：初始版本，基于最新代码架构和功能实现
